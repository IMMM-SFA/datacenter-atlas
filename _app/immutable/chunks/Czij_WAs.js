var St=Object.defineProperty;var Mt=(r,e,t)=>e in r?St(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var w=(r,e,t)=>Mt(r,typeof e!="symbol"?e+"":e,t);import{i as Tt,a as tt,d as y,r as Ct,b as Lt,D as ee,l as b,c as Rt,e as xt,T as ne,f as Ce,g as Le,h as Re,j as kt,k as It,P as Dt,R as X,s as xe,I as we,W as At,m as ke,n as Ot,w as Ie,p as it,o as st,V as ie,C as Vt,q as zt,M as _e,t as Ft,u as Nt,S as Ut,v as ve,x as jt,y as ae,z as Bt,A as W,L as B,B as $,E as Gt,F as Wt,G as M,H as De,J as U,K as nt,N as ce,O as Ht,Q as Y,U as Zt,X as $t,Y as qt,Z as Ae,_ as Xt,$ as Yt,a0 as Kt,a1 as Jt,a2 as Qt}from"./BRAD2MUl.js";const ei="4.3.2";var et;const ti=(et=globalThis.loaders)==null?void 0:et.parseImageNode,he=typeof Image<"u",le=typeof ImageBitmap<"u",ii=!!ti,de=Tt?!0:ii;function si(r){switch(r){case"auto":return le||he||de;case"imagebitmap":return le;case"image":return he;case"data":return de;default:throw new Error(`@loaders.gl/images: image ${r} not supported in this environment`)}}function ni(){if(le)return"imagebitmap";if(he)return"image";if(de)return"data";throw new Error("Install '@loaders.gl/polyfills' to parse images under Node.js")}function ri(r){const e=ai(r);if(!e)throw new Error("Not an image");return e}function oi(r){switch(ri(r)){case"data":return r;case"image":case"imagebitmap":const e=document.createElement("canvas"),t=e.getContext("2d");if(!t)throw new Error("getImageData");return e.width=r.width,e.height=r.height,t.drawImage(r,0,0),t.getImageData(0,0,r.width,r.height);default:throw new Error("getImageData")}}function ai(r){return typeof ImageBitmap<"u"&&r instanceof ImageBitmap?"imagebitmap":typeof Image<"u"&&r instanceof Image?"image":r&&typeof r=="object"&&r.data&&r.width&&r.height?"data":null}const ci=/^data:image\/svg\+xml/,hi=/\.svg((\?|#).*)?$/;function ye(r){return r&&(ci.test(r)||hi.test(r))}function li(r,e){if(ye(e)){let i=new TextDecoder().decode(r);try{typeof unescape=="function"&&typeof encodeURIComponent=="function"&&(i=unescape(encodeURIComponent(i)))}catch(n){throw new Error(n.message)}return`data:image/svg+xml;base64,${btoa(i)}`}return rt(r,e)}function rt(r,e){if(ye(e))throw new Error("SVG cannot be parsed directly to imagebitmap");return new Blob([new Uint8Array(r)])}async function ot(r,e,t){const i=li(r,t),s=self.URL||self.webkitURL,n=typeof i!="string"&&s.createObjectURL(i);try{return await di(n||i,e)}finally{n&&s.revokeObjectURL(n)}}async function di(r,e){const t=new Image;return t.src=r,e.image&&e.image.decode&&t.decode?(await t.decode(),t):await new Promise((i,s)=>{try{t.onload=()=>i(t),t.onerror=n=>{const o=n instanceof Error?n.message:"error";s(new Error(o))}}catch(n){s(n)}})}const ui={};let Oe=!0;async function pi(r,e,t){let i;ye(t)?i=await ot(r,e,t):i=rt(r,t);const s=e&&e.imagebitmap;return await fi(i,s)}async function fi(r,e=null){if((gi(e)||!Oe)&&(e=null),e)try{return await createImageBitmap(r,e)}catch(t){console.warn(t),Oe=!1}return await createImageBitmap(r)}function gi(r){for(const e in r||ui)return!1;return!0}function mi(r){return!yi(r,"ftyp",4)||(r[8]&96)===0?null:wi(r)}function wi(r){switch(_i(r,8,12).replace("\0"," ").trim()){case"avif":case"avis":return{extension:"avif",mimeType:"image/avif"};default:return null}}function _i(r,e,t){return String.fromCharCode(...r.slice(e,t))}function vi(r){return[...r].map(e=>e.charCodeAt(0))}function yi(r,e,t=0){const i=vi(e);for(let s=0;s<i.length;++s)if(i[s]!==r[s+t])return!1;return!0}const T=!1,G=!0;function at(r){const e=q(r);return bi(e)||Mi(e)||Pi(e)||Si(e)||Ei(e)}function Ei(r){const e=new Uint8Array(r instanceof DataView?r.buffer:r),t=mi(e);return t?{mimeType:t.mimeType,width:0,height:0}:null}function bi(r){const e=q(r);return e.byteLength>=24&&e.getUint32(0,T)===2303741511?{mimeType:"image/png",width:e.getUint32(16,T),height:e.getUint32(20,T)}:null}function Pi(r){const e=q(r);return e.byteLength>=10&&e.getUint32(0,T)===1195984440?{mimeType:"image/gif",width:e.getUint16(6,G),height:e.getUint16(8,G)}:null}function Si(r){const e=q(r);return e.byteLength>=14&&e.getUint16(0,T)===16973&&e.getUint32(2,G)===e.byteLength?{mimeType:"image/bmp",width:e.getUint32(18,G),height:e.getUint32(22,G)}:null}function Mi(r){const e=q(r);if(!(e.byteLength>=3&&e.getUint16(0,T)===65496&&e.getUint8(2)===255))return null;const{tableMarkers:i,sofMarkers:s}=Ti();let n=2;for(;n+9<e.byteLength;){const o=e.getUint16(n,T);if(s.has(o))return{mimeType:"image/jpeg",height:e.getUint16(n+5,T),width:e.getUint16(n+7,T)};if(!i.has(o))return null;n+=2,n+=e.getUint16(n,T)}return null}function Ti(){const r=new Set([65499,65476,65484,65501,65534]);for(let t=65504;t<65520;++t)r.add(t);return{tableMarkers:r,sofMarkers:new Set([65472,65473,65474,65475,65477,65478,65479,65481,65482,65483,65485,65486,65487,65502])}}function q(r){if(r instanceof DataView)return r;if(ArrayBuffer.isView(r))return new DataView(r.buffer);if(r instanceof ArrayBuffer)return new DataView(r);throw new Error("toDataView")}async function Ci(r,e){var s;const{mimeType:t}=at(r)||{},i=(s=globalThis.loaders)==null?void 0:s.parseImageNode;return tt(i),await i(r,t)}async function Li(r,e,t){e=e||{};const s=(e.image||{}).type||"auto",{url:n}=t||{},o=Ri(s);let a;switch(o){case"imagebitmap":a=await pi(r,e,n);break;case"image":a=await ot(r,e,n);break;case"data":a=await Ci(r);break;default:tt(!1)}return s==="data"&&(a=oi(a)),a}function Ri(r){switch(r){case"auto":case"data":return ni();default:return si(r),r}}const xi=["png","jpg","jpeg","gif","webp","bmp","ico","svg","avif"],ki=["image/png","image/jpeg","image/gif","image/webp","image/avif","image/bmp","image/vnd.microsoft.icon","image/svg+xml"],Ii={image:{type:"auto",decode:!0}},Di={dataType:null,batchType:null,id:"image",module:"images",name:"Images",version:ei,mimeTypes:ki,extensions:xi,parse:Li,tests:[r=>!!at(new DataView(r))],options:Ii};function Ai(r){const e=r[0],t=r[r.length-1];return e==="{"&&t==="}"||e==="["&&t==="]"}const Oi={dataType:null,batchType:null,id:"JSON",name:"JSON",module:"",version:"",options:{},extensions:["json","geojson"],mimeTypes:["application/json","application/geo+json"],testText:Ai,parseTextSync:JSON.parse};function Vi(){const r="9.1.12",e=globalThis.deck&&globalThis.deck.VERSION;if(e&&e!==r)throw new Error(`deck.gl - multiple versions detected: ${e} vs ${r}`);return e||(y.log(1,`deck.gl ${r}`)(),globalThis.deck={...globalThis.deck,VERSION:r,version:r,log:y,_registerLoggers:Ct},Lt([Oi,[Di,{imagebitmap:{premultiplyAlpha:"none"}}]])),r}const zi=Vi(),Fi=xt()&&typeof document<"u",Ni=()=>Fi&&document.readyState==="complete",Ui="set luma.log.level=1 (or higher) to trace rendering",Ve="No matching device found. Ensure `@luma.gl/webgl` and/or `@luma.gl/webgpu` modules are imported.",D=class D{constructor(){w(this,"stats",Rt);w(this,"log",b);w(this,"VERSION","9.1.9");w(this,"spector");w(this,"preregisteredAdapters",new Map);if(globalThis.luma){if(globalThis.luma.VERSION!==this.VERSION)throw b.error(`Found luma.gl ${globalThis.luma.VERSION} while initialzing ${this.VERSION}`)(),b.error("'yarn why @luma.gl/core' can help identify the source of the conflict")(),new Error("luma.gl - multiple versions detected: see console log");b.error("This version of luma.gl has already been initialized")()}b.log(1,`${this.VERSION} - ${Ui}`)(),globalThis.luma=this}registerAdapters(e){for(const t of e)this.preregisteredAdapters.set(t.type,t)}getSupportedAdapters(e=[]){const t=this.getAdapterMap(e);return Array.from(t).map(([,i])=>i).filter(i=>{var s;return(s=i.isSupported)==null?void 0:s.call(i)}).map(i=>i.type)}getBestAvailableAdapter(e=[]){var i,s,n,o;const t=this.getAdapterMap(e);return(s=(i=t.get("webgpu"))==null?void 0:i.isSupported)!=null&&s.call(i)?"webgpu":(o=(n=t.get("webgl"))==null?void 0:n.isSupported)!=null&&o.call(n)?"webgl":null}setDefaultDeviceProps(e){Object.assign(D.defaultProps,e)}async createDevice(e={}){var a;e={...D.defaultProps,...e},e.waitForPageLoad&&await D.pageLoaded;const t=this.getAdapterMap(e.adapters);let i=e.type||"";i==="best-available"&&(i=this.getBestAvailableAdapter(e.adapters)||i);const n=(this.getAdapterMap(e.adapters)||t).get(i),o=await((a=n==null?void 0:n.create)==null?void 0:a.call(n,e));if(o)return o;throw new Error(Ve)}async attachDevice(e){var o;const t=this.getAdapterMap(e.adapters);let i="";e.handle instanceof WebGL2RenderingContext&&(i="webgl"),e.createCanvasContext&&await D.pageLoaded,e.handle===null&&(i="unknown");const s=t.get(i),n=await((o=s==null?void 0:s.attach)==null?void 0:o.call(s,null));if(n)return n;throw new Error(Ve)}enforceWebGL2(e=!0,t=[]){var n;const s=this.getAdapterMap(t).get("webgl");s||b.warn("enforceWebGL2: webgl adapter not found")(),(n=s==null?void 0:s.enforceWebGL2)==null||n.call(s,e)}getAdapterMap(e=[]){const t=new Map(this.preregisteredAdapters);for(const i of e)t.set(i.type,i);return t}registerDevices(e){b.warn("luma.registerDevices() is deprecated, use luma.registerAdapters() instead");for(const t of e){const i=t.adapter;i&&this.preregisteredAdapters.set(i.type,i)}}};w(D,"defaultProps",{...ee.defaultProps,type:"best-available",adapters:void 0,waitForPageLoad:!0}),w(D,"pageLoaded",ji().then(()=>{b.probe(2,"DOM is loaded")()}));let ue=D;const pe=new ue;function ji(){return Ni()||typeof window>"u"?Promise.resolve():new Promise(r=>{window.addEventListener("load",()=>r())})}class Bi{}const ze=`uniform layerUniforms {
  uniform float opacity;
} layer;
`,Gi={name:"layer",vs:ze,fs:ze,getUniforms:r=>({opacity:Math.pow(r.opacity,1/2.2)}),uniformTypes:{opacity:"f32"}};function Wi(r){if(r.includes(ne))return ne;const e=r.includes(Ce),t=r.includes(Le);return e&&t?ne:e||t?e?Ce:Le:r.includes(Re)?Re:kt}class Hi{constructor(e,t){this.actions="",this.manager=e,this.set(t)}set(e){e===It&&(e=this.compute()),this.manager.element&&(this.manager.element.style.touchAction=e,this.actions=e)}update(){this.set(this.manager.options.touchAction)}compute(){let e=[];for(const t of this.manager.recognizers)t.options.enable&&(e=e.concat(t.getTouchAction()));return Wi(e.join(" "))}}const Zi=["","webkit","Moz","MS","ms","o"];function $i(r,e){const t=e[0].toUpperCase()+e.slice(1);for(const i of Zi){const s=i?i+t:e;if(s in r)return s}}const qi=1,Fe=2,Ne={touchAction:"compute",enable:!0,inputTarget:null,cssProps:{userSelect:"none",userDrag:"none",touchCallout:"none",tapHighlightColor:"rgba(0,0,0,0)"}};class Xi{constructor(e,t){this.options={...Ne,...t,cssProps:{...Ne.cssProps,...t.cssProps},inputTarget:t.inputTarget||e},this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new Dt(this),this.touchAction=new Hi(this,this.options.touchAction),this.toggleCssProps(!0)}set(e){return Object.assign(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this}stop(e){this.session.stopped=e?Fe:qi}recognize(e){const{session:t}=this;if(t.stopped)return;this.session.prevented&&e.srcEvent.preventDefault();let i;const{recognizers:s}=this;let{curRecognizer:n}=t;(!n||n&&n.state&X.Recognized)&&(n=t.curRecognizer=null);let o=0;for(;o<s.length;)i=s[o],t.stopped!==Fe&&(!n||i===n||i.canRecognizeWith(n))?i.recognize(e):i.reset(),!n&&i.state&(X.Began|X.Changed|X.Ended)&&(n=t.curRecognizer=i),o++}get(e){const{recognizers:t}=this;for(let i=0;i<t.length;i++)if(t[i].options.event===e)return t[i];return null}add(e){if(Array.isArray(e)){for(const i of e)this.add(i);return this}const t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e}remove(e){if(Array.isArray(e)){for(const i of e)this.remove(i);return this}const t=typeof e=="string"?this.get(e):e;if(t){const{recognizers:i}=this,s=i.indexOf(t);s!==-1&&(i.splice(s,1),this.touchAction.update())}return this}on(e,t){if(!e||!t)return;const{handlers:i}=this;for(const s of xe(e))i[s]=i[s]||[],i[s].push(t)}off(e,t){if(!e)return;const{handlers:i}=this;for(const s of xe(e))t?i[s]&&i[s].splice(i[s].indexOf(t),1):delete i[s]}emit(e,t){const i=this.handlers[e]&&this.handlers[e].slice();if(!i||!i.length)return;const s=t;s.type=e,s.preventDefault=function(){t.srcEvent.preventDefault()};let n=0;for(;n<i.length;)i[n](s),n++}destroy(){this.toggleCssProps(!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}toggleCssProps(e){const{element:t}=this;if(t){for(const[i,s]of Object.entries(this.options.cssProps)){const n=$i(t.style,i);e?(this.oldCssProps[n]=t.style[n],t.style[n]=s):t.style[n]=this.oldCssProps[n]||""}e||(this.oldCssProps={})}}}const Ue=["mousedown","mousemove","mouseup","mouseover","mouseout","mouseleave"];class Yi extends we{constructor(e,t,i){super(e,t,{enable:!0,...i}),this.handleEvent=n=>{this.handleOverEvent(n),this.handleOutEvent(n),this.handleEnterEvent(n),this.handleLeaveEvent(n),this.handleMoveEvent(n)},this.pressed=!1;const{enable:s}=this.options;this.enableMoveEvent=s,this.enableLeaveEvent=s,this.enableEnterEvent=s,this.enableOutEvent=s,this.enableOverEvent=s,Ue.forEach(n=>e.addEventListener(n,this.handleEvent))}destroy(){Ue.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){switch(e){case"pointermove":this.enableMoveEvent=t;break;case"pointerover":this.enableOverEvent=t;break;case"pointerout":this.enableOutEvent=t;break;case"pointerenter":this.enableEnterEvent=t;break;case"pointerleave":this.enableLeaveEvent=t;break}}handleOverEvent(e){this.enableOverEvent&&e.type==="mouseover"&&this._emit("pointerover",e)}handleOutEvent(e){this.enableOutEvent&&e.type==="mouseout"&&this._emit("pointerout",e)}handleEnterEvent(e){this.enableEnterEvent&&e.type==="mouseenter"&&this._emit("pointerenter",e)}handleLeaveEvent(e){this.enableLeaveEvent&&e.type==="mouseleave"&&this._emit("pointerleave",e)}handleMoveEvent(e){if(this.enableMoveEvent)switch(e.type){case"mousedown":e.button>=0&&(this.pressed=!0);break;case"mousemove":e.buttons===0&&(this.pressed=!1),this.pressed||this._emit("pointermove",e);break;case"mouseup":this.pressed=!1;break}}_emit(e,t){this.callback({type:e,center:{x:t.clientX,y:t.clientY},srcEvent:t,pointerType:"mouse",target:t.target})}}const je=["keydown","keyup"];class Ki extends we{constructor(e,t,i){super(e,t,{enable:!0,tabIndex:0,...i}),this.handleEvent=s=>{const n=s.target||s.srcElement;n.tagName==="INPUT"&&n.type==="text"||n.tagName==="TEXTAREA"||(this.enableDownEvent&&s.type==="keydown"&&this.callback({type:"keydown",srcEvent:s,key:s.key,target:s.target}),this.enableUpEvent&&s.type==="keyup"&&this.callback({type:"keyup",srcEvent:s,key:s.key,target:s.target}))},this.enableDownEvent=this.options.enable,this.enableUpEvent=this.options.enable,e.tabIndex=this.options.tabIndex,e.style.outline="none",je.forEach(s=>e.addEventListener(s,this.handleEvent))}destroy(){je.forEach(e=>this.element.removeEventListener(e,this.handleEvent))}enableEventType(e,t){e==="keydown"&&(this.enableDownEvent=t),e==="keyup"&&(this.enableUpEvent=t)}}class Ji extends we{constructor(e,t,i){super(e,t,i),this.handleEvent=s=>{this.options.enable&&this.callback({type:"contextmenu",center:{x:s.clientX,y:s.clientY},srcEvent:s,pointerType:"mouse",target:s.target})},e.addEventListener("contextmenu",this.handleEvent)}destroy(){this.element.removeEventListener("contextmenu",this.handleEvent)}enableEventType(e,t){e==="contextmenu"&&(this.options.enable=t)}}const Be=1,fe=2,Ge=4,Qi={pointerdown:Be,pointermove:fe,pointerup:Ge,mousedown:Be,mousemove:fe,mouseup:Ge},es=0,ts=1,is=2,ss=1,ns=2,rs=4;function os(r){const e=Qi[r.srcEvent.type];if(!e)return null;const{buttons:t,button:i}=r.srcEvent;let s=!1,n=!1,o=!1;return e===fe?(s=!!(t&ss),n=!!(t&rs),o=!!(t&ns)):(s=i===es,n=i===ts,o=i===is),{leftButton:s,middleButton:n,rightButton:o}}function as(r,e){const t=r.center;if(!t)return null;const i=e.getBoundingClientRect(),s=i.width/e.offsetWidth||1,n=i.height/e.offsetHeight||1,o={x:(t.x-i.left-e.clientLeft)/s,y:(t.y-i.top-e.clientTop)/n};return{center:t,offsetCenter:o}}const cs={srcElement:"root",priority:0};class hs{constructor(e,t){this.handleEvent=i=>{if(this.isEmpty())return;const s=this._normalizeEvent(i);let n=i.srcEvent.target;for(;n&&n!==s.rootElement;){if(this._emit(s,n),s.handled)return;n=n.parentNode}this._emit(s,"root")},this.eventManager=e,this.recognizerName=t,this.handlers=[],this.handlersByElement=new Map,this._active=!1}isEmpty(){return!this._active}add(e,t,i,s=!1,n=!1){const{handlers:o,handlersByElement:a}=this,c={...cs,...i};let h=a.get(c.srcElement);h||(h=[],a.set(c.srcElement,h));const l={type:e,handler:t,srcElement:c.srcElement,priority:c.priority};s&&(l.once=!0),n&&(l.passive=!0),o.push(l),this._active=this._active||!l.passive;let u=h.length-1;for(;u>=0&&!(h[u].priority>=l.priority);)u--;h.splice(u+1,0,l)}remove(e,t){const{handlers:i,handlersByElement:s}=this;for(let n=i.length-1;n>=0;n--){const o=i[n];if(o.type===e&&o.handler===t){i.splice(n,1);const a=s.get(o.srcElement);a.splice(a.indexOf(o),1),a.length===0&&s.delete(o.srcElement)}}this._active=i.some(n=>!n.passive)}_emit(e,t){const i=this.handlersByElement.get(t);if(i){let s=!1;const n=()=>{e.handled=!0},o=()=>{e.handled=!0,s=!0},a=[];for(let c=0;c<i.length;c++){const{type:h,handler:l,once:u}=i[c];if(l({...e,type:h,stopPropagation:n,stopImmediatePropagation:o}),u&&a.push(i[c]),s)break}for(let c=0;c<a.length;c++){const{type:h,handler:l}=a[c];this.remove(h,l)}}}_normalizeEvent(e){const t=this.eventManager.getElement();return{...e,...os(e),...as(e,t),preventDefault:()=>{e.srcEvent.preventDefault()},stopImmediatePropagation:null,stopPropagation:null,handled:!1,rootElement:t}}}function ls(r){if("recognizer"in r)return r;let e;const t=Array.isArray(r)?[...r]:[r];if(typeof t[0]=="function"){const i=t.shift(),s=t.shift()||{};e=new i(s)}else e=t.shift();return{recognizer:e,recognizeWith:typeof t[0]=="string"?[t[0]]:t[0],requireFailure:typeof t[1]=="string"?[t[1]]:t[1]}}class ds{constructor(e=null,t={}){if(this._onBasicInput=i=>{this.manager.emit(i.srcEvent.type,i)},this._onOtherEvent=i=>{this.manager.emit(i.type,i)},this.options={recognizers:[],events:{},touchAction:"compute",tabIndex:0,cssProps:{},...t},this.events=new Map,this.element=e,!!e){this.manager=new Xi(e,this.options);for(const i of this.options.recognizers){const{recognizer:s,recognizeWith:n,requireFailure:o}=ls(i);this.manager.add(s),n&&s.recognizeWith(n),o&&s.requireFailure(o)}this.manager.on("hammer.input",this._onBasicInput),this.wheelInput=new At(e,this._onOtherEvent,{enable:!1}),this.moveInput=new Yi(e,this._onOtherEvent,{enable:!1}),this.keyInput=new Ki(e,this._onOtherEvent,{enable:!1,tabIndex:t.tabIndex}),this.contextmenuInput=new Ji(e,this._onOtherEvent,{enable:!1}),this.on(this.options.events)}}getElement(){return this.element}destroy(){this.element&&(this.wheelInput.destroy(),this.moveInput.destroy(),this.keyInput.destroy(),this.contextmenuInput.destroy(),this.manager.destroy())}on(e,t,i){this._addEventHandler(e,t,i,!1)}once(e,t,i){this._addEventHandler(e,t,i,!0)}watch(e,t,i){this._addEventHandler(e,t,i,!1,!0)}off(e,t){this._removeEventHandler(e,t)}_toggleRecognizer(e,t){var n,o,a,c;const{manager:i}=this;if(!i)return;const s=i.get(e);s&&(s.set({enable:t}),i.touchAction.update()),(n=this.wheelInput)==null||n.enableEventType(e,t),(o=this.moveInput)==null||o.enableEventType(e,t),(a=this.keyInput)==null||a.enableEventType(e,t),(c=this.contextmenuInput)==null||c.enableEventType(e,t)}_addEventHandler(e,t,i,s,n){if(typeof e!="string"){i=t;for(const[h,l]of Object.entries(e))this._addEventHandler(h,l,i,s,n);return}const{manager:o,events:a}=this;if(!o)return;let c=a.get(e);if(!c){const h=this._getRecognizerName(e)||e;c=new hs(this,h),a.set(e,c),o&&o.on(e,c.handleEvent)}c.add(e,t,i,s,n),c.isEmpty()||this._toggleRecognizer(c.recognizerName,!0)}_removeEventHandler(e,t){if(typeof e!="string"){for(const[n,o]of Object.entries(e))this._removeEventHandler(n,o);return}const{events:i}=this,s=i.get(e);if(s&&(s.remove(e,t),s.isEmpty())){const{recognizerName:n}=s;let o=!1;for(const a of i.values())if(a.recognizerName===n&&!a.isEmpty()){o=!0;break}o||this._toggleRecognizer(n,!1)}}_getRecognizerName(e){var t;return(t=this.manager.recognizers.find(i=>i.getEventNames().includes(e)))==null?void 0:t.options.event}}const We=512;function us(r){const{width:e,height:t,pitch:i=0}=r;let{longitude:s,latitude:n,zoom:o,bearing:a=0}=r;(s<-180||s>180)&&(s=ke(s+180,360)-180),(a<-180||a>180)&&(a=ke(a+180,360)-180);const c=Ot(t/We);if(o<=c)o=c,n=0;else{const h=t/2/Math.pow(2,o),l=Ie([0,h])[1];if(n<l)n=l;else{const u=Ie([0,We-h])[1];n>u&&(n=u)}}return{width:e,height:t,longitude:s,latitude:n,zoom:o,pitch:i,bearing:a}}const ct=`
uniform shadowUniforms {
  bool drawShadowMap;
  bool useShadowMap;
  vec4 color;
  highp int lightId;
  float lightCount;
  mat4 viewProjectionMatrix0;
  mat4 viewProjectionMatrix1;
  vec4 projectCenter0;
  vec4 projectCenter1;
} shadow;
`,ps=`
const int max_lights = 2;

out vec3 shadow_vPosition[max_lights];

vec4 shadow_setVertexPosition(vec4 position_commonspace) {
  mat4 viewProjectionMatrices[max_lights];
  viewProjectionMatrices[0] = shadow.viewProjectionMatrix0;
  viewProjectionMatrices[1] = shadow.viewProjectionMatrix1;
  vec4 projectCenters[max_lights];
  projectCenters[0] = shadow.projectCenter0;
  projectCenters[1] = shadow.projectCenter1;

  if (shadow.drawShadowMap) {
    return project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[shadow.lightId], projectCenters[shadow.lightId]);
  }
  if (shadow.useShadowMap) {
    for (int i = 0; i < max_lights; i++) {
      if(i < int(shadow.lightCount)) {
        vec4 shadowMap_position = project_common_position_to_clipspace(position_commonspace, viewProjectionMatrices[i], projectCenters[i]);
        shadow_vPosition[i] = (shadowMap_position.xyz / shadowMap_position.w + 1.0) / 2.0;
      }
    }
  }
  return gl_Position;
}
`,fs=`
${ct}
${ps}
`,gs=`
const int max_lights = 2;
uniform sampler2D shadow_uShadowMap0;
uniform sampler2D shadow_uShadowMap1;

in vec3 shadow_vPosition[max_lights];

const vec4 bitPackShift = vec4(1.0, 255.0, 65025.0, 16581375.0);
const vec4 bitUnpackShift = 1.0 / bitPackShift;
const vec4 bitMask = vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0,  0.0);

float shadow_getShadowWeight(vec3 position, sampler2D shadowMap) {
  vec4 rgbaDepth = texture(shadowMap, position.xy);

  float z = dot(rgbaDepth, bitUnpackShift);
  return smoothstep(0.001, 0.01, position.z - z);
}

vec4 shadow_filterShadowColor(vec4 color) {
  if (shadow.drawShadowMap) {
    vec4 rgbaDepth = fract(gl_FragCoord.z * bitPackShift);
    rgbaDepth -= rgbaDepth.gbaa * bitMask;
    return rgbaDepth;
  }
  if (shadow.useShadowMap) {
    float shadowAlpha = 0.0;
    shadowAlpha += shadow_getShadowWeight(shadow_vPosition[0], shadow_uShadowMap0);
    if(shadow.lightCount > 1.0) {
      shadowAlpha += shadow_getShadowWeight(shadow_vPosition[1], shadow_uShadowMap1);
    }
    shadowAlpha *= shadow.color.a / shadow.lightCount;
    float blendedAlpha = shadowAlpha + color.a * (1.0 - shadowAlpha);

    return vec4(
      mix(color.rgb, shadow.color.rgb, shadowAlpha / blendedAlpha),
      blendedAlpha
    );
  }
  return color;
}
`,ms=`
${ct}
${gs}
`,ws=st(bs),_s=st(Ps),vs=[0,0,0,1],ys=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0];function Es(r,e){const[t,i,s]=r,n=Ft([t,i,s],e);return Number.isFinite(s)?n:[n[0],n[1],0]}function bs({viewport:r,center:e}){return new _e(r.viewProjectionMatrix).invert().transform(e)}function Ps({viewport:r,shadowMatrices:e}){const t=[],i=r.pixelUnprojectionMatrix,s=r.isGeospatial?void 0:1,n=[[0,0,s],[r.width,0,s],[0,r.height,s],[r.width,r.height,s],[0,0,-1],[r.width,0,-1],[0,r.height,-1],[r.width,r.height,-1]].map(o=>Es(o,i));for(const o of e){const a=o.clone().translate(new ie(r.center).negate()),c=n.map(l=>a.transform(l)),h=new _e().ortho({left:Math.min(...c.map(l=>l[0])),right:Math.max(...c.map(l=>l[0])),bottom:Math.min(...c.map(l=>l[1])),top:Math.max(...c.map(l=>l[1])),near:Math.min(...c.map(l=>-l[2])),far:Math.max(...c.map(l=>-l[2]))});t.push(h.multiplyRight(o))}return t}function Ss(r){const{shadowEnabled:e=!0,project:t}=r;if(!e||!t||!r.shadowMatrices||!r.shadowMatrices.length)return{drawShadowMap:!1,useShadowMap:!1,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};const i=it.getUniforms(t),s=ws({viewport:t.viewport,center:i.center}),n=[],o=_s({shadowMatrices:r.shadowMatrices,viewport:t.viewport}).slice();for(let c=0;c<r.shadowMatrices.length;c++){const h=o[c],l=h.clone().translate(new ie(t.viewport.center).negate());i.coordinateSystem===Vt.LNGLAT&&i.projectionMode===zt.WEB_MERCATOR?(o[c]=l,n[c]=s):(o[c]=h.clone().multiplyRight(ys),n[c]=l.transform(s))}const a={drawShadowMap:!!r.drawToShadowMap,useShadowMap:r.shadowMaps?r.shadowMaps.length>0:!1,color:r.shadowColor||vs,lightId:r.shadowLightId||0,lightCount:r.shadowMatrices.length,shadow_uShadowMap0:r.dummyShadowMap,shadow_uShadowMap1:r.dummyShadowMap};for(let c=0;c<o.length;c++)a[`viewProjectionMatrix${c}`]=o[c],a[`projectCenter${c}`]=n[c];for(let c=0;c<2;c++)a[`shadow_uShadowMap${c}`]=r.shadowMaps&&r.shadowMaps[c]||r.dummyShadowMap;return a}const He={name:"shadow",dependencies:[it],vs:fs,fs:ms,inject:{"vs:DECKGL_FILTER_GL_POSITION":`
    position = shadow_setVertexPosition(geometry.position);
    `,"fs:DECKGL_FILTER_COLOR":`
    color = shadow_filterShadowColor(color);
    `},getUniforms:Ss,uniformTypes:{drawShadowMap:"f32",useShadowMap:"f32",color:"vec4<f32>",lightId:"i32",lightCount:"f32",viewProjectionMatrix0:"mat4x4<f32>",viewProjectionMatrix1:"mat4x4<f32>",projectCenter0:"vec4<f32>",projectCenter1:"vec4<f32>"}},Ms=[Nt],Ts=["vs:DECKGL_FILTER_SIZE(inout vec3 size, VertexGeometry geometry)","vs:DECKGL_FILTER_GL_POSITION(inout vec4 position, VertexGeometry geometry)","vs:DECKGL_FILTER_COLOR(inout vec4 color, VertexGeometry geometry)","fs:DECKGL_FILTER_COLOR(inout vec4 color, FragmentGeometry geometry)"],Cs=[];function Ls(r){const e=Ut.getDefaultShaderAssembler();for(const i of Ms)e.addDefaultModule(i);const t=r==="glsl"?Ts:Cs;for(const i of t)e.addShaderHook(i);return e}const Rs=[255,255,255],xs=1;let ks=0;class Is{constructor(e={}){this.type="ambient";const{color:t=Rs}=e,{intensity:i=xs}=e;this.id=e.id||`ambient-${ks++}`,this.color=t,this.intensity=i}}const Ds=[255,255,255],As=1,Os=[0,0,-1];let Vs=0;class Ze{constructor(e={}){this.type="directional";const{color:t=Ds}=e,{intensity:i=As}=e,{direction:s=Os}=e,{_shadow:n=!1}=e;this.id=e.id||`directional-${Vs++}`,this.color=t,this.intensity=i,this.type="directional",this.direction=new ie(s).normalize().toArray(),this.shadow=n}getProjectedLight(e){return this}}class zs{constructor(e,t={id:"pass"}){const{id:i}=t;this.id=i,this.device=e,this.props={...t}}setProps(e){Object.assign(this.props,e)}render(e){}cleanup(){}}class Ee extends zs{constructor(){super(...arguments),this._lastRenderIndex=-1}render(e){const[t,i]=this.device.canvasContext.getDrawingBufferSize(),s=e.clearCanvas??!0,n=e.clearColor??(s?[0,0,0,0]:!1),o=s?1:!1,a=s?0:!1,c=e.colorMask??15,h={viewport:[0,0,t,i]};e.colorMask&&(h.colorMask=c),e.scissorRect&&(h.scissorRect=e.scissorRect);const l=this.device.beginRenderPass({framebuffer:e.target,parameters:h,clearColor:n,clearDepth:o,clearStencil:a});try{return this._drawLayers(l,e)}finally{l.end(),this.device.submit()}}_drawLayers(e,t){const{target:i,shaderModuleProps:s,viewports:n,views:o,onViewportActive:a,clearStack:c=!0}=t;t.pass=t.pass||"unknown",c&&(this._lastRenderIndex=-1);const h=[];for(const l of n){const u=o&&o[l.id];a==null||a(l);const d=this._getDrawLayerParams(l,t),p=l.subViewports||[l];for(const g of p){const f=this._drawLayersInViewport(e,{target:i,shaderModuleProps:s,viewport:g,view:u,pass:t.pass,layers:t.layers},d);h.push(f)}}return h}_getDrawLayerParams(e,{layers:t,pass:i,isPicking:s=!1,layerFilter:n,cullRect:o,effects:a,shaderModuleProps:c},h=!1){var g;const l=[],u=ht(this._lastRenderIndex+1),d={layer:t[0],viewport:e,isPicking:s,renderPass:i,cullRect:o},p={};for(let f=0;f<t.length;f++){const m=t[f],v=this._shouldDrawLayer(m,d,n,p),_={shouldDrawLayer:v};v&&!h&&(_.shouldDrawLayer=!0,_.layerRenderIndex=u(m,v),_.shaderModuleProps=this._getShaderModuleProps(m,a,i,c),_.layerParameters={...(g=m.context.deck)==null?void 0:g.props.parameters,...this.getLayerParameters(m,f,e)}),l[f]=_}return l}_drawLayersInViewport(e,{layers:t,shaderModuleProps:i,pass:s,target:n,viewport:o,view:a},c){const h=Fs(this.device,{shaderModuleProps:i,target:n,viewport:o});if(a&&a.props.clear){const u=a.props.clear===!0?{color:!0,depth:!0}:a.props.clear;this.device.beginRenderPass({framebuffer:n,parameters:{viewport:h,scissorRect:h},clearColor:u.color?[0,0,0,0]:!1,clearDepth:u.depth?1:!1}).end()}const l={totalCount:t.length,visibleCount:0,compositeCount:0,pickableCount:0};e.setParameters({viewport:h});for(let u=0;u<t.length;u++){const d=t[u],p=c[u],{shouldDrawLayer:g}=p;if(g&&d.props.pickable&&l.pickableCount++,d.isComposite&&l.compositeCount++,d.isDrawable&&p.shouldDrawLayer){const{layerRenderIndex:f,shaderModuleProps:m,layerParameters:v}=p;l.visibleCount++,this._lastRenderIndex=Math.max(this._lastRenderIndex,f),m.project&&(m.project.viewport=o),d.context.renderPass=e;try{d._drawLayer({renderPass:e,shaderModuleProps:m,uniforms:{layerIndex:f},parameters:v})}catch(_){d.raiseError(_,`drawing ${d} to ${s}`)}}}return l}shouldDrawLayer(e){return!0}getShaderModuleProps(e,t,i){return null}getLayerParameters(e,t,i){return e.props.parameters}_shouldDrawLayer(e,t,i,s){if(!(e.props.visible&&this.shouldDrawLayer(e)))return!1;t.layer=e;let o=e.parent;for(;o;){if(!o.props.visible||!o.filterSubLayer(t))return!1;t.layer=o,o=o.parent}if(i){const a=t.layer.id;if(a in s||(s[a]=i(t)),!s[a])return!1}return e.activateViewport(t.viewport),!0}_getShaderModuleProps(e,t,i,s){var c,h;const n=this.device.canvasContext.cssToDeviceRatio(),o=((c=e.internalState)==null?void 0:c.propsInTransition)||e.props,a={layer:o,picking:{isActive:!1},project:{viewport:e.context.viewport,devicePixelRatio:n,modelMatrix:o.modelMatrix,coordinateSystem:o.coordinateSystem,coordinateOrigin:o.coordinateOrigin,autoWrapLongitude:e.wrapLongitude}};if(t)for(const l of t)$e(a,(h=l.getShaderModuleProps)==null?void 0:h.call(l,e,a));return $e(a,this.getShaderModuleProps(e,t,a),s)}}function ht(r=0,e={}){const t={},i=(s,n)=>{const o=s.props._offset,a=s.id,c=s.parent&&s.parent.id;let h;if(c&&!(c in e)&&i(s.parent,!1),c in t){const l=t[c]=t[c]||ht(e[c],e);h=l(s,n),t[a]=l}else Number.isFinite(o)?(h=o+(e[c]||0),t[a]=null):h=r;return n&&h>=r&&(r=h+1),e[a]=h,h};return i}function Fs(r,{shaderModuleProps:e,target:t,viewport:i}){var c;const s=((c=e==null?void 0:e.project)==null?void 0:c.devicePixelRatio)??r.canvasContext.cssToDeviceRatio(),[,n]=r.canvasContext.getDrawingBufferSize(),o=t?t.height:n,a=i;return[a.x*s,o-(a.y+a.height)*s,a.width*s,a.height*s]}function $e(r,...e){for(const t of e)if(t)for(const i in t)r[i]?Object.assign(r[i],t[i]):r[i]=t[i];return r}class Ns extends Ee{constructor(e,t){super(e,t);const i=e.createTexture({format:"rgba8unorm",width:1,height:1,sampler:{minFilter:"linear",magFilter:"linear",addressModeU:"clamp-to-edge",addressModeV:"clamp-to-edge"},mipmaps:!0}),s=e.createTexture({format:"depth16unorm",width:1,height:1,mipmaps:!1});this.fbo=e.createFramebuffer({id:"shadowmap",width:1,height:1,colorAttachments:[i],depthStencilAttachment:s})}delete(){this.fbo&&(this.fbo.destroy(),this.fbo=null)}getShadowMap(){return this.fbo.colorAttachments[0].texture}render(e){const t=this.fbo,i=this.device.canvasContext.cssToDeviceRatio(),s=e.viewports[0],n=s.width*i,o=s.height*i,a=[1,1,1,1];(n!==t.width||o!==t.height)&&t.resize({width:n,height:o}),super.render({...e,clearColor:a,target:t,pass:"shadow"})}getLayerParameters(e,t,i){return{...e.props.parameters,blend:!1,depthWriteEnabled:!0,depthCompare:"less-equal"}}shouldDrawLayer(e){return e.props.shadowEnabled!==!1}getShaderModuleProps(e,t,i){return{shadow:{project:i.project,drawToShadowMap:!0}}}}const Us={color:[255,255,255],intensity:1},qe=[{color:[255,255,255],intensity:1,direction:[-1,3,-1]},{color:[255,255,255],intensity:.9,direction:[1,-8,-2.5]}],js=[0,0,0,200/255];class lt{constructor(e={}){this.id="lighting-effect",this.shadowColor=js,this.shadow=!1,this.directionalLights=[],this.pointLights=[],this.shadowPasses=[],this.dummyShadowMap=null,this.setProps(e)}setup(e){this.context=e;const{device:t,deck:i}=e;this.shadow&&!this.dummyShadowMap&&(this._createShadowPasses(t),i._addDefaultShaderModule(He),this.dummyShadowMap=t.createTexture({width:1,height:1}))}setProps(e){this.ambientLight=void 0,this.directionalLights=[],this.pointLights=[];for(const t in e){const i=e[t];switch(i.type){case"ambient":this.ambientLight=i;break;case"directional":this.directionalLights.push(i);break;case"point":this.pointLights.push(i);break}}this._applyDefaultLights(),this.shadow=this.directionalLights.some(t=>t.shadow),this.context&&this.setup(this.context),this.props=e}preRender({layers:e,layerFilter:t,viewports:i,onViewportActive:s,views:n}){if(this.shadow){this.shadowMatrices=this._calculateMatrices();for(let o=0;o<this.shadowPasses.length;o++)this.shadowPasses[o].render({layers:e,layerFilter:t,viewports:i,onViewportActive:s,views:n,shaderModuleProps:{shadow:{shadowLightId:o,dummyShadowMap:this.dummyShadowMap,shadowMatrices:this.shadowMatrices}}})}}getShaderModuleProps(e,t){const i=this.shadow?{project:t.project,shadowMaps:this.shadowPasses.map(o=>o.getShadowMap()),dummyShadowMap:this.dummyShadowMap,shadowColor:this.shadowColor,shadowMatrices:this.shadowMatrices}:{},s={enabled:!0,ambientLight:this.ambientLight,directionalLights:this.directionalLights.map(o=>o.getProjectedLight({layer:e})),pointLights:this.pointLights.map(o=>o.getProjectedLight({layer:e}))},n=e.props.material;return{shadow:i,lighting:s,phongMaterial:n,gouraudMaterial:n}}cleanup(e){for(const t of this.shadowPasses)t.delete();this.shadowPasses.length=0,this.dummyShadowMap&&(this.dummyShadowMap.destroy(),this.dummyShadowMap=null,e.deck._removeDefaultShaderModule(He))}_calculateMatrices(){const e=[];for(const t of this.directionalLights){const i=new _e().lookAt({eye:new ie(t.direction).negate()});e.push(i)}return e}_createShadowPasses(e){for(let t=0;t<this.directionalLights.length;t++){const i=new Ns(e);this.shadowPasses[t]=i}}_applyDefaultLights(){const{ambientLight:e,pointLights:t,directionalLights:i}=this;!e&&t.length===0&&i.length===0&&(this.ambientLight=new Is(Us),this.directionalLights.push(new Ze(qe[0]),new Ze(qe[1])))}}let Bs=1,Gs=1;class dt{constructor(){w(this,"time",0);w(this,"channels",new Map);w(this,"animations",new Map);w(this,"playing",!1);w(this,"lastEngineTime",-1)}addChannel(e){const{delay:t=0,duration:i=Number.POSITIVE_INFINITY,rate:s=1,repeat:n=1}=e,o=Bs++,a={time:0,delay:t,duration:i,rate:s,repeat:n};return this._setChannelTime(a,this.time),this.channels.set(o,a),o}removeChannel(e){this.channels.delete(e);for(const[t,i]of this.animations)i.channel===e&&this.detachAnimation(t)}isFinished(e){const t=this.channels.get(e);return t===void 0?!1:this.time>=t.delay+t.duration*t.repeat}getTime(e){if(e===void 0)return this.time;const t=this.channels.get(e);return t===void 0?-1:t.time}setTime(e){this.time=Math.max(0,e);const t=this.channels.values();for(const s of t)this._setChannelTime(s,this.time);const i=this.animations.values();for(const s of i){const{animation:n,channel:o}=s;n.setTime(this.getTime(o))}}play(){this.playing=!0}pause(){this.playing=!1,this.lastEngineTime=-1}reset(){this.setTime(0)}attachAnimation(e,t){const i=Gs++;return this.animations.set(i,{animation:e,channel:t}),e.setTime(this.getTime(t)),i}detachAnimation(e){this.animations.delete(e)}update(e){this.playing&&(this.lastEngineTime===-1&&(this.lastEngineTime=e),this.setTime(this.time+(e-this.lastEngineTime)),this.lastEngineTime=e)}_setChannelTime(e,t){const i=t-e.delay,s=e.duration*e.repeat;i>=s?e.time=e.duration*e.rate:(e.time=Math.max(0,i)%e.duration,e.time*=e.rate)}}function Ws(r){return typeof window<"u"&&window.requestAnimationFrame?window.requestAnimationFrame(r):setTimeout(r,1e3/60)}function Hs(r){return typeof window<"u"&&window.cancelAnimationFrame?window.cancelAnimationFrame(r):clearTimeout(r)}let Zs=0;const $s={device:null,onAddHTML:()=>"",onInitialize:async()=>null,onRender:()=>{},onFinalize:()=>{},onError:r=>console.error(r),stats:pe.stats.get(`animation-loop-${Zs++}`),useDevicePixels:!0,autoResizeViewport:!1,autoResizeDrawingBuffer:!1};class qs{constructor(e){w(this,"device",null);w(this,"canvas",null);w(this,"props");w(this,"animationProps",null);w(this,"timeline",null);w(this,"stats");w(this,"cpuTime");w(this,"gpuTime");w(this,"frameRate");w(this,"display");w(this,"needsRedraw","initialized");w(this,"_initialized",!1);w(this,"_running",!1);w(this,"_animationFrameId",null);w(this,"_nextFramePromise",null);w(this,"_resolveNextFrame",null);w(this,"_cpuStartTime",0);w(this,"_error",null);if(this.props={...$s,...e},e=this.props,!e.device)throw new Error("No device provided");const{useDevicePixels:t=!0}=this.props;this.stats=e.stats||new ve({id:"animation-loop-stats"}),this.cpuTime=this.stats.get("CPU Time"),this.gpuTime=this.stats.get("GPU Time"),this.frameRate=this.stats.get("Frame Rate"),this.setProps({autoResizeViewport:e.autoResizeViewport,autoResizeDrawingBuffer:e.autoResizeDrawingBuffer,useDevicePixels:t}),this.start=this.start.bind(this),this.stop=this.stop.bind(this),this._onMousemove=this._onMousemove.bind(this),this._onMouseleave=this._onMouseleave.bind(this)}destroy(){this.stop(),this._setDisplay(null)}delete(){this.destroy()}setError(e){var i,s;if(this.props.onError(e),this._error=Error(),((s=(i=this.device)==null?void 0:i.canvasContext)==null?void 0:s.canvas)instanceof HTMLCanvasElement){const n=document.createElement("h1");n.innerHTML=e.message,n.style.position="absolute",n.style.top="20%",n.style.left="10px",n.style.color="black",n.style.backgroundColor="red",document.body.appendChild(n)}}setNeedsRedraw(e){return this.needsRedraw=this.needsRedraw||e,this}setProps(e){return"autoResizeViewport"in e&&(this.props.autoResizeViewport=e.autoResizeViewport||!1),"autoResizeDrawingBuffer"in e&&(this.props.autoResizeDrawingBuffer=e.autoResizeDrawingBuffer||!1),"useDevicePixels"in e&&(this.props.useDevicePixels=e.useDevicePixels||!1),this}async start(){if(this._running)return this;this._running=!0;try{let e;return this._initialized||(this._initialized=!0,await this._initDevice(),this._initialize(),await this.props.onInitialize(this._getAnimationProps())),this._running?(e!==!1&&(this._cancelAnimationFrame(),this._requestAnimationFrame()),this):null}catch(e){const t=e instanceof Error?e:new Error("Unknown error");throw this.props.onError(t),t}}stop(){return this._running&&(this.animationProps&&!this._error&&this.props.onFinalize(this.animationProps),this._cancelAnimationFrame(),this._nextFramePromise=null,this._resolveNextFrame=null,this._running=!1),this}redraw(){var e;return(e=this.device)!=null&&e.isLost||this._error?this:(this._beginFrameTimers(),this._setupFrame(),this._updateAnimationProps(),this._renderFrame(this._getAnimationProps()),this._clearNeedsRedraw(),this._resolveNextFrame&&(this._resolveNextFrame(this),this._nextFramePromise=null,this._resolveNextFrame=null),this._endFrameTimers(),this)}attachTimeline(e){return this.timeline=e,this.timeline}detachTimeline(){this.timeline=null}waitForRender(){return this.setNeedsRedraw("waitForRender"),this._nextFramePromise||(this._nextFramePromise=new Promise(e=>{this._resolveNextFrame=e})),this._nextFramePromise}async toDataURL(){if(this.setNeedsRedraw("toDataURL"),await this.waitForRender(),this.canvas instanceof HTMLCanvasElement)return this.canvas.toDataURL();throw new Error("OffscreenCanvas")}_initialize(){this._startEventHandling(),this._initializeAnimationProps(),this._updateAnimationProps(),this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_setDisplay(e){this.display&&(this.display.destroy(),this.display.animationLoop=null),e&&(e.animationLoop=this),this.display=e}_requestAnimationFrame(){this._running&&(this._animationFrameId=Ws(this._animationFrame.bind(this)))}_cancelAnimationFrame(){this._animationFrameId!==null&&(Hs(this._animationFrameId),this._animationFrameId=null)}_animationFrame(){this._running&&(this.redraw(),this._requestAnimationFrame())}_renderFrame(e){var t;if(this.display){this.display._renderFrame(e);return}this.props.onRender(this._getAnimationProps()),(t=this.device)==null||t.submit()}_clearNeedsRedraw(){this.needsRedraw=!1}_setupFrame(){this._resizeCanvasDrawingBuffer(),this._resizeViewport()}_initializeAnimationProps(){var t,i;const e=(i=(t=this.device)==null?void 0:t.canvasContext)==null?void 0:i.canvas;if(!this.device||!e)throw new Error("loop");this.animationProps={animationLoop:this,device:this.device,canvas:e,timeline:this.timeline,useDevicePixels:this.props.useDevicePixels,needsRedraw:!1,width:1,height:1,aspect:1,time:0,startTime:Date.now(),engineTime:0,tick:0,tock:0,_mousePosition:null}}_getAnimationProps(){if(!this.animationProps)throw new Error("animationProps");return this.animationProps}_updateAnimationProps(){if(!this.animationProps)return;const{width:e,height:t,aspect:i}=this._getSizeAndAspect();(e!==this.animationProps.width||t!==this.animationProps.height)&&this.setNeedsRedraw("drawing buffer resized"),i!==this.animationProps.aspect&&this.setNeedsRedraw("drawing buffer aspect changed"),this.animationProps.width=e,this.animationProps.height=t,this.animationProps.aspect=i,this.animationProps.needsRedraw=this.needsRedraw,this.animationProps.engineTime=Date.now()-this.animationProps.startTime,this.timeline&&this.timeline.update(this.animationProps.engineTime),this.animationProps.tick=Math.floor(this.animationProps.time/1e3*60),this.animationProps.tock++,this.animationProps.time=this.timeline?this.timeline.getTime():this.animationProps.engineTime}async _initDevice(){var e;if(this.device=await this.props.device,!this.device)throw new Error("No device provided");this.canvas=((e=this.device.canvasContext)==null?void 0:e.canvas)||null}_createInfoDiv(){if(this.canvas&&this.props.onAddHTML){const e=document.createElement("div");document.body.appendChild(e),e.style.position="relative";const t=document.createElement("div");t.style.position="absolute",t.style.left="10px",t.style.bottom="10px",t.style.width="300px",t.style.background="white",this.canvas instanceof HTMLCanvasElement&&e.appendChild(this.canvas),e.appendChild(t);const i=this.props.onAddHTML(t);i&&(t.innerHTML=i)}}_getSizeAndAspect(){var n,o,a,c;if(!this.device)return{width:1,height:1,aspect:1};const[e,t]=((o=(n=this.device)==null?void 0:n.canvasContext)==null?void 0:o.getPixelSize())||[1,1];let i=1;const s=(c=(a=this.device)==null?void 0:a.canvasContext)==null?void 0:c.canvas;return s&&s.clientHeight?i=s.clientWidth/s.clientHeight:e>0&&t>0&&(i=e/t),{width:e,height:t,aspect:i}}_resizeViewport(){this.props.autoResizeViewport&&this.device.gl&&this.device.gl.viewport(0,0,this.device.gl.drawingBufferWidth,this.device.gl.drawingBufferHeight)}_resizeCanvasDrawingBuffer(){var e,t;this.props.autoResizeDrawingBuffer&&((t=(e=this.device)==null?void 0:e.canvasContext)==null||t.resize({useDevicePixels:this.props.useDevicePixels}))}_beginFrameTimers(){this.frameRate.timeEnd(),this.frameRate.timeStart(),this.cpuTime.timeStart()}_endFrameTimers(){this.cpuTime.timeEnd()}_startEventHandling(){this.canvas&&(this.canvas.addEventListener("mousemove",this._onMousemove.bind(this)),this.canvas.addEventListener("mouseleave",this._onMouseleave.bind(this)))}_onMousemove(e){e instanceof MouseEvent&&(this._getAnimationProps()._mousePosition=[e.offsetX,e.offsetY])}_onMouseleave(e){this._getAnimationProps()._mousePosition=null}}const Xs={blendColorOperation:"add",blendColorSrcFactor:"one",blendColorDstFactor:"zero",blendAlphaOperation:"add",blendAlphaSrcFactor:"constant-alpha",blendAlphaDstFactor:"zero"};class ut extends Ee{constructor(){super(...arguments),this._colorEncoderState=null}render(e){return"pickingFBO"in e?this._drawPickingBuffer(e):super.render(e)}_drawPickingBuffer({layers:e,layerFilter:t,views:i,viewports:s,onViewportActive:n,pickingFBO:o,deviceRect:{x:a,y:c,width:h,height:l},cullRect:u,effects:d,pass:p="picking",pickZ:g,shaderModuleProps:f}){this.pickZ=g;const m=this._resetColorEncoder(g),v=[a,c,h,l],_=super.render({target:o,layers:e,layerFilter:t,views:i,viewports:s,onViewportActive:n,cullRect:u,effects:d==null?void 0:d.filter(L=>L.useInPicking),pass:p,isPicking:!0,shaderModuleProps:f,clearColor:[0,0,0,0],colorMask:15,scissorRect:v});return this._colorEncoderState=null,{decodePickingColor:m&&Ks.bind(null,m),stats:_}}shouldDrawLayer(e){const{pickable:t,operation:i}=e.props;return t&&i.includes("draw")||i.includes("terrain")||i.includes("mask")}getShaderModuleProps(e,t,i){return{picking:{isActive:1,isAttribute:this.pickZ},lighting:{enabled:!1}}}getLayerParameters(e,t,i){const s={...e.props.parameters},{pickable:n,operation:o}=e.props;return!this._colorEncoderState||o.includes("terrain")?s.blend=!1:n&&o.includes("draw")&&(Object.assign(s,Xs),s.blend=!0,s.blendColor=Ys(this._colorEncoderState,e,i)),s}_resetColorEncoder(e){return this._colorEncoderState=e?null:{byLayer:new Map,byAlpha:[]},this._colorEncoderState}}function Ys(r,e,t){const{byLayer:i,byAlpha:s}=r;let n,o=i.get(e);return o?(o.viewports.push(t),n=o.a):(n=i.size+1,n<=255?(o={a:n,layer:e,viewports:[t]},i.set(e,o),s[n]=o):(y.warn("Too many pickable layers, only picking the first 255")(),n=0)),[0,0,0,n/255]}function Ks(r,e){const t=r.byAlpha[e[3]];return t&&{pickedLayer:t.layer,pickedViewports:t.viewports,pickedObjectIndex:t.layer.decodePickingColor(e)}}class Js{constructor(e,t,i){this._loadCount=0,this._subscribers=new Set,this.id=e,this.context=i,this.setData(t)}subscribe(e){this._subscribers.add(e)}unsubscribe(e){this._subscribers.delete(e)}inUse(){return this._subscribers.size>0}delete(){}getData(){return this.isLoaded?this._error?Promise.reject(this._error):this._content:this._loader.then(()=>this.getData())}setData(e,t){if(e===this._data&&!t)return;this._data=e;const i=++this._loadCount;let s=e;typeof e=="string"&&(s=jt(e)),s instanceof Promise?(this.isLoaded=!1,this._loader=s.then(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=void 0,this._content=n)}).catch(n=>{this._loadCount===i&&(this.isLoaded=!0,this._error=n||!0)})):(this.isLoaded=!0,this._error=void 0,this._content=e);for(const n of this._subscribers)n.onChange(this.getData())}}class Qs{constructor(e){var t;this.protocol=e.protocol||"resource://",this._context={device:e.device,gl:(t=e.device)==null?void 0:t.gl,resourceManager:this},this._resources={},this._consumers={},this._pruneRequest=null}contains(e){return e.startsWith(this.protocol)?!0:e in this._resources}add({resourceId:e,data:t,forceUpdate:i=!1,persistent:s=!0}){let n=this._resources[e];n?n.setData(t,i):(n=new Js(e,t,this._context),this._resources[e]=n),n.persistent=s}remove(e){const t=this._resources[e];t&&(t.delete(),delete this._resources[e])}unsubscribe({consumerId:e}){const t=this._consumers[e];if(t){for(const i in t){const s=t[i],n=this._resources[s.resourceId];n&&n.unsubscribe(s)}delete this._consumers[e],this.prune()}}subscribe({resourceId:e,onChange:t,consumerId:i,requestId:s="default"}){const{_resources:n,protocol:o}=this;e.startsWith(o)&&(e=e.replace(o,""),n[e]||this.add({resourceId:e,data:null,persistent:!1}));const a=n[e];if(this._track(i,s,a,t),a)return a.getData()}prune(){this._pruneRequest||(this._pruneRequest=setTimeout(()=>this._prune(),0))}finalize(){for(const e in this._resources)this._resources[e].delete()}_track(e,t,i,s){const n=this._consumers,o=n[e]=n[e]||{};let a=o[t];const c=a&&a.resourceId&&this._resources[a.resourceId];c&&(c.unsubscribe(a),this.prune()),i&&(a?(a.onChange=s,a.resourceId=i.id):a={onChange:s,resourceId:i.id},o[t]=a,i.subscribe(a))}_prune(){this._pruneRequest=null;for(const e of Object.keys(this._resources)){const t=this._resources[e];!t.persistent&&!t.inUse()&&(t.delete(),delete this._resources[e])}}}const en="layerManager.setLayers",tn="layerManager.activateViewport";class sn{constructor(e,t){var a;this._lastRenderedLayers=[],this._needsRedraw=!1,this._needsUpdate=!1,this._nextLayers=null,this._debug=!1,this._defaultShaderModulesChanged=!1,this.activateViewport=c=>{ae(tn,this,c),c&&(this.context.viewport=c)};const{deck:i,stats:s,viewport:n,timeline:o}=t||{};this.layers=[],this.resourceManager=new Qs({device:e,protocol:"deck://"}),this.context={mousePosition:null,userData:{},layerManager:this,device:e,gl:e==null?void 0:e.gl,deck:i,shaderAssembler:Ls(((a=e==null?void 0:e.info)==null?void 0:a.shadingLanguage)||"glsl"),defaultShaderModules:[Gi],renderPass:void 0,stats:s||new ve({id:"deck.gl"}),viewport:n||new Bt({id:"DEFAULT-INITIAL-VIEWPORT"}),timeline:o||new dt,resourceManager:this.resourceManager,onError:void 0},Object.seal(this)}finalize(){this.resourceManager.finalize();for(const e of this.layers)this._finalizeLayer(e)}needsRedraw(e={clearRedrawFlags:!1}){let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);for(const i of this.layers){const s=i.getNeedsRedraw(e);t=t||s}return t}needsUpdate(){return this._nextLayers&&this._nextLayers!==this._lastRenderedLayers?"layers changed":this._defaultShaderModulesChanged?"shader modules changed":this._needsUpdate}setNeedsRedraw(e){this._needsRedraw=this._needsRedraw||e}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e}getLayers({layerIds:e}={}){return e?this.layers.filter(t=>e.find(i=>t.id.indexOf(i)===0)):this.layers}setProps(e){"debug"in e&&(this._debug=e.debug),"userData"in e&&(this.context.userData=e.userData),"layers"in e&&(this._nextLayers=e.layers),"onError"in e&&(this.context.onError=e.onError)}setLayers(e,t){ae(en,this,t,e),this._lastRenderedLayers=e;const i=W(e,Boolean);for(const s of i)s.context=this.context;this._updateLayers(this.layers,i)}updateLayers(){const e=this.needsUpdate();e&&(this.setNeedsRedraw(`updating layers: ${e}`),this.setLayers(this._nextLayers||this._lastRenderedLayers,e)),this._nextLayers=null}addDefaultShaderModule(e){const{defaultShaderModules:t}=this.context;t.find(i=>i.name===e.name)||(t.push(e),this._defaultShaderModulesChanged=!0)}removeDefaultShaderModule(e){const{defaultShaderModules:t}=this.context,i=t.findIndex(s=>s.name===e.name);i>=0&&(t.splice(i,1),this._defaultShaderModulesChanged=!0)}_handleError(e,t,i){i.raiseError(t,`${e} of ${i}`)}_updateLayers(e,t){const i={};for(const o of e)i[o.id]?y.warn(`Multiple old layers with same id ${o.id}`)():i[o.id]=o;if(this._defaultShaderModulesChanged){for(const o of e)o.setNeedsUpdate(),o.setChangeFlags({extensionsChanged:!0});this._defaultShaderModulesChanged=!1}const s=[];this._updateSublayersRecursively(t,i,s),this._finalizeOldLayers(i);let n=!1;for(const o of s)if(o.hasUniformTransition()){n=`Uniform transition in ${o}`;break}this._needsUpdate=n,this.layers=s}_updateSublayersRecursively(e,t,i){for(const s of e){s.context=this.context;const n=t[s.id];n===null&&y.warn(`Multiple new layers with same id ${s.id}`)(),t[s.id]=null;let o=null;try{this._debug&&n!==s&&s.validateProps(),n?(this._transferLayerState(n,s),this._updateLayer(s)):this._initializeLayer(s),i.push(s),o=s.isComposite?s.getSubLayers():null}catch(a){this._handleError("matching",a,s)}o&&this._updateSublayersRecursively(o,t,i)}}_finalizeOldLayers(e){for(const t in e){const i=e[t];i&&this._finalizeLayer(i)}}_initializeLayer(e){try{e._initialize(),e.lifecycle=B.INITIALIZED}catch(t){this._handleError("initialization",t,e)}}_transferLayerState(e,t){t._transferState(e),t.lifecycle=B.MATCHED,t!==e&&(e.lifecycle=B.AWAITING_GC)}_updateLayer(e){try{e._update()}catch(t){this._handleError("update",t,e)}}_finalizeLayer(e){this._needsRedraw=this._needsRedraw||`finalized ${e}`,e.lifecycle=B.AWAITING_FINALIZATION;try{e._finalize(),e.lifecycle=B.FINALIZED}catch(t){this._handleError("finalization",t,e)}}}class nn{constructor(e){this.views=[],this.width=100,this.height=100,this.viewState={},this.controllers={},this.timeline=e.timeline,this._viewports=[],this._viewportMap={},this._isUpdating=!1,this._needsRedraw="First render",this._needsUpdate="Initialize",this._eventManager=e.eventManager,this._eventCallbacks={onViewStateChange:e.onViewStateChange,onInteractionStateChange:e.onInteractionStateChange},Object.seal(this),this.setProps(e)}finalize(){for(const e in this.controllers){const t=this.controllers[e];t&&t.finalize()}this.controllers={}}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}setNeedsUpdate(e){this._needsUpdate=this._needsUpdate||e,this._needsRedraw=this._needsRedraw||e}updateViewStates(){for(const e in this.controllers){const t=this.controllers[e];t&&t.updateTransition()}}getViewports(e){return e?this._viewports.filter(t=>t.containsPixel(e)):this._viewports}getViews(){const e={};return this.views.forEach(t=>{e[t.id]=t}),e}getView(e){return this.views.find(t=>t.id===e)}getViewState(e){const t=typeof e=="string"?this.getView(e):e,i=t&&this.viewState[t.getViewStateId()]||this.viewState;return t?t.filterViewState(i):i}getViewport(e){return this._viewportMap[e]}unproject(e,t){const i=this.getViewports(),s={x:e[0],y:e[1]};for(let n=i.length-1;n>=0;--n){const o=i[n];if(o.containsPixel(s)){const a=e.slice();return a[0]-=o.x,a[1]-=o.y,o.unproject(a,t)}}return null}setProps(e){e.views&&this._setViews(e.views),e.viewState&&this._setViewState(e.viewState),("width"in e||"height"in e)&&this._setSize(e.width,e.height),this._isUpdating||this._update()}_update(){this._isUpdating=!0,this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._needsUpdate&&(this._needsUpdate=!1,this._rebuildViewports()),this._isUpdating=!1}_setSize(e,t){(e!==this.width||t!==this.height)&&(this.width=e,this.height=t,this.setNeedsUpdate("Size changed"))}_setViews(e){e=W(e,Boolean),this._diffViews(e,this.views)&&this.setNeedsUpdate("views changed"),this.views=e}_setViewState(e){e?(!$(e,this.viewState,3)&&this.setNeedsUpdate("viewState changed"),this.viewState=e):y.warn("missing `viewState` or `initialViewState`")()}_createController(e,t){const i=t.type;return new i({timeline:this.timeline,eventManager:this._eventManager,onViewStateChange:this._eventCallbacks.onViewStateChange,onStateChange:this._eventCallbacks.onInteractionStateChange,makeViewport:n=>{var o;return(o=this.getView(e.id))==null?void 0:o.makeViewport({viewState:n,width:this.width,height:this.height})}})}_updateController(e,t,i,s){const n=e.controller;if(n&&i){const o={...t,...n,id:e.id,x:i.x,y:i.y,width:i.width,height:i.height};return(!s||s.constructor!==n.type)&&(s=this._createController(e,o)),s&&s.setProps(o),s}return null}_rebuildViewports(){const{views:e}=this,t=this.controllers;this._viewports=[],this.controllers={};let i=!1;for(let s=e.length;s--;){const n=e[s],o=this.getViewState(n),a=n.makeViewport({viewState:o,width:this.width,height:this.height});let c=t[n.id];const h=!!n.controller;h&&!c&&(i=!0),(i||!h)&&c&&(c.finalize(),c=null),this.controllers[n.id]=this._updateController(n,o,a,c),a&&this._viewports.unshift(a)}for(const s in t){const n=t[s];n&&!this.controllers[s]&&n.finalize()}this._buildViewportMap()}_buildViewportMap(){this._viewportMap={},this._viewports.forEach(e=>{e.id&&(this._viewportMap[e.id]=this._viewportMap[e.id]||e)})}_diffViews(e,t){return e.length!==t.length?!0:e.some((i,s)=>!e[s].equals(t[s]))}}const rn=/([0-9]+\.?[0-9]*)(%|px)/;function R(r){switch(typeof r){case"number":return{position:r,relative:!1};case"string":const e=rn.exec(r);if(e&&e.length>=3){const t=e[2]==="%",i=parseFloat(e[1]);return{position:t?i/100:i,relative:t}}default:throw new Error(`Could not parse position string ${r}`)}}function x(r,e){return r.relative?Math.round(r.position*e):r.position}class pt{constructor(e){const{id:t,x:i=0,y:s=0,width:n="100%",height:o="100%",padding:a=null}=e;this.id=t||this.constructor.displayName||"view",this.props={...e,id:this.id},this._x=R(i),this._y=R(s),this._width=R(n),this._height=R(o),this._padding=a&&{left:R(a.left||0),right:R(a.right||0),top:R(a.top||0),bottom:R(a.bottom||0)},this.equals=this.equals.bind(this),Object.seal(this)}equals(e){return this===e?!0:this.constructor===e.constructor&&$(this.props,e.props,2)}makeViewport({width:e,height:t,viewState:i}){i=this.filterViewState(i);const s=this.getDimensions({width:e,height:t});if(!s.height||!s.width)return null;const n=this.getViewportType(i);return new n({...i,...this.props,...s})}getViewStateId(){const{viewState:e}=this.props;return typeof e=="string"?e:(e==null?void 0:e.id)||this.id}filterViewState(e){if(this.props.viewState&&typeof this.props.viewState=="object"){if(!this.props.viewState.id)return this.props.viewState;const t={...e};for(const i in this.props.viewState)i!=="id"&&(t[i]=this.props.viewState[i]);return t}return e}getDimensions({width:e,height:t}){const i={x:x(this._x,e),y:x(this._y,t),width:x(this._width,e),height:x(this._height,t)};return this._padding&&(i.padding={left:x(this._padding.left,e),top:x(this._padding.top,t),right:x(this._padding.right,e),bottom:x(this._padding.bottom,t)}),i}get controller(){const e=this.props.controller;return e?e===!0?{type:this.ControllerType}:typeof e=="function"?{type:e}:{type:this.ControllerType,...e}:null}}const Xe=()=>{},ge={BREAK:1,SNAP_TO_END:2,IGNORE:3},on=r=>r,an=ge.BREAK;class cn{constructor(e){this._onTransitionUpdate=t=>{const{time:i,settings:{interpolator:s,startProps:n,endProps:o,duration:a,easing:c}}=t,h=c(i/a),l=s.interpolateProps(n,o,h);this.propsInTransition=this.getControllerState({...this.props,...l}).getViewportProps(),this.onViewStateChange({viewState:this.propsInTransition,oldViewState:this.props})},this.getControllerState=e.getControllerState,this.propsInTransition=null,this.transition=new Gt(e.timeline),this.onViewStateChange=e.onViewStateChange||Xe,this.onStateChange=e.onStateChange||Xe}finalize(){this.transition.cancel()}getViewportInTransition(){return this.propsInTransition}processViewStateChange(e){let t=!1;const i=this.props;if(this.props=e,!i||this._shouldIgnoreViewportChange(i,e))return!1;if(this._isTransitionEnabled(e)){let s=i;if(this.transition.inProgress){const{interruption:n,endProps:o}=this.transition.settings;s={...i,...n===ge.SNAP_TO_END?o:this.propsInTransition||i}}this._triggerTransition(s,e),t=!0}else this.transition.cancel();return t}updateTransition(){this.transition.update()}_isTransitionEnabled(e){const{transitionDuration:t,transitionInterpolator:i}=e;return(t>0||t==="auto")&&!!i}_isUpdateDueToCurrentTransition(e){return this.transition.inProgress&&this.propsInTransition?this.transition.settings.interpolator.arePropsEqual(e,this.propsInTransition):!1}_shouldIgnoreViewportChange(e,t){return this.transition.inProgress?this.transition.settings.interruption===ge.IGNORE||this._isUpdateDueToCurrentTransition(t):this._isTransitionEnabled(t)?t.transitionInterpolator.arePropsEqual(e,t):!0}_triggerTransition(e,t){const i=this.getControllerState(e),s=this.getControllerState(t).shortestPathFrom(i),n=t.transitionInterpolator,o=n.getDuration?n.getDuration(e,t):t.transitionDuration;if(o===0)return;const a=n.initializeProps(e,s);this.propsInTransition={};const c={duration:o,easing:t.transitionEasing||on,interpolator:n,interruption:t.transitionInterruption||an,startProps:a.start,endProps:a.end,onStart:t.onTransitionStart,onUpdate:this._onTransitionUpdate,onInterrupt:this._onTransitionEnd(t.onTransitionInterrupt),onEnd:this._onTransitionEnd(t.onTransitionEnd)};this.transition.start(c),this.onStateChange({inTransition:!0}),this.updateTransition()}_onTransitionEnd(e){return t=>{this.propsInTransition=null,this.onStateChange({inTransition:!1,isZooming:!1,isPanning:!1,isRotating:!1}),e==null||e(t)}}}class hn{constructor(e){const{compare:t,extract:i,required:s}=e;this._propsToCompare=t,this._propsToExtract=i||t,this._requiredProps=s}arePropsEqual(e,t){for(const i of this._propsToCompare)if(!(i in e)||!(i in t)||!Wt(e[i],t[i]))return!1;return!0}initializeProps(e,t){const i={},s={};for(const n of this._propsToExtract)(n in e||n in t)&&(i[n]=e[n],s[n]=t[n]);return this._checkRequiredProps(i),this._checkRequiredProps(s),{start:i,end:s}}getDuration(e,t){return t.transitionDuration}_checkRequiredProps(e){this._requiredProps&&this._requiredProps.forEach(t=>{const i=e[t];M(Number.isFinite(i)||Array.isArray(i),`${t} is required for transition`)})}}const ln=["longitude","latitude","zoom","bearing","pitch"],dn=["longitude","latitude","zoom"];class be extends hn{constructor(e={}){const t=Array.isArray(e)?e:e.transitionProps,i=Array.isArray(e)?{}:e;i.transitionProps=Array.isArray(t)?{compare:t,required:t}:t||{compare:ln,required:dn},super(i.transitionProps),this.opts=i}initializeProps(e,t){const i=super.initializeProps(e,t),{makeViewport:s,around:n}=this.opts;if(s&&n){const o=s(e),a=s(t),c=o.unproject(n);i.start.around=n,Object.assign(i.end,{around:a.project(c),aroundPosition:c,width:t.width,height:t.height})}return i}interpolateProps(e,t,i){const s={};for(const n of this._propsToExtract)s[n]=De(e[n]||0,t[n]||0,i);if(t.aroundPosition&&this.opts.makeViewport){const n=this.opts.makeViewport({...t,...s});Object.assign(s,n.panByPosition(t.aroundPosition,De(e.around,t.around,i)))}return s}}const k={transitionDuration:0},un=300,K=r=>1-(1-r)*(1-r),N={WHEEL:["wheel"],PAN:["panstart","panmove","panend"],PINCH:["pinchstart","pinchmove","pinchend"],MULTI_PAN:["multipanstart","multipanmove","multipanend"],DOUBLE_CLICK:["dblclick"],KEYBOARD:["keydown"]},O={};class ft{constructor(e){this.state={},this._events={},this._interactionState={isDragging:!1},this._customEvents=[],this._eventStartBlocked=null,this._panMove=!1,this.invertPan=!1,this.dragMode="rotate",this.inertia=0,this.scrollZoom=!0,this.dragPan=!0,this.dragRotate=!0,this.doubleClickZoom=!0,this.touchZoom=!0,this.touchRotate=!1,this.keyboard=!0,this.transitionManager=new cn({...e,getControllerState:t=>new this.ControllerState(t),onViewStateChange:this._onTransition.bind(this),onStateChange:this._setInteractionState.bind(this)}),this.handleEvent=this.handleEvent.bind(this),this.eventManager=e.eventManager,this.onViewStateChange=e.onViewStateChange||(()=>{}),this.onStateChange=e.onStateChange||(()=>{}),this.makeViewport=e.makeViewport}set events(e){this.toggleEvents(this._customEvents,!1),this.toggleEvents(e,!0),this._customEvents=e,this.props&&this.setProps(this.props)}finalize(){var e;for(const t in this._events)this._events[t]&&((e=this.eventManager)==null||e.off(t,this.handleEvent));this.transitionManager.finalize()}handleEvent(e){this._controllerState=void 0;const t=this._eventStartBlocked;switch(e.type){case"panstart":return t?!1:this._onPanStart(e);case"panmove":return this._onPan(e);case"panend":return this._onPanEnd(e);case"pinchstart":return t?!1:this._onPinchStart(e);case"pinchmove":return this._onPinch(e);case"pinchend":return this._onPinchEnd(e);case"multipanstart":return t?!1:this._onMultiPanStart(e);case"multipanmove":return this._onMultiPan(e);case"multipanend":return this._onMultiPanEnd(e);case"dblclick":return this._onDoubleClick(e);case"wheel":return this._onWheel(e);case"keydown":return this._onKeyDown(e);default:return!1}}get controllerState(){return this._controllerState=this._controllerState||new this.ControllerState({makeViewport:this.makeViewport,...this.props,...this.state}),this._controllerState}getCenter(e){const{x:t,y:i}=this.props,{offsetCenter:s}=e;return[s.x-t,s.y-i]}isPointInBounds(e,t){const{width:i,height:s}=this.props;if(t&&t.handled)return!1;const n=e[0]>=0&&e[0]<=i&&e[1]>=0&&e[1]<=s;return n&&t&&t.stopPropagation(),n}isFunctionKeyPressed(e){const{srcEvent:t}=e;return!!(t.metaKey||t.altKey||t.ctrlKey||t.shiftKey)}isDragging(){return this._interactionState.isDragging||!1}blockEvents(e){const t=setTimeout(()=>{this._eventStartBlocked===t&&(this._eventStartBlocked=null)},e);this._eventStartBlocked=t}setProps(e){e.dragMode&&(this.dragMode=e.dragMode),this.props=e,"transitionInterpolator"in e||(e.transitionInterpolator=this._getTransitionProps().transitionInterpolator),this.transitionManager.processViewStateChange(e);const{inertia:t}=e;this.inertia=Number.isFinite(t)?t:t===!0?un:0;const{scrollZoom:i=!0,dragPan:s=!0,dragRotate:n=!0,doubleClickZoom:o=!0,touchZoom:a=!0,touchRotate:c=!1,keyboard:h=!0}=e,l=!!this.onViewStateChange;this.toggleEvents(N.WHEEL,l&&i),this.toggleEvents(N.PAN,l),this.toggleEvents(N.PINCH,l&&(a||c)),this.toggleEvents(N.MULTI_PAN,l&&c),this.toggleEvents(N.DOUBLE_CLICK,l&&o),this.toggleEvents(N.KEYBOARD,l&&h),this.scrollZoom=i,this.dragPan=s,this.dragRotate=n,this.doubleClickZoom=o,this.touchZoom=a,this.touchRotate=c,this.keyboard=h}updateTransition(){this.transitionManager.updateTransition()}toggleEvents(e,t){this.eventManager&&e.forEach(i=>{this._events[i]!==t&&(this._events[i]=t,t?this.eventManager.on(i,this.handleEvent):this.eventManager.off(i,this.handleEvent))})}updateViewport(e,t=null,i={}){const s={...e.getViewportProps(),...t},n=this.controllerState!==e;if(this.state=e.getState(),this._setInteractionState(i),n){const o=this.controllerState&&this.controllerState.getViewportProps();this.onViewStateChange&&this.onViewStateChange({viewState:s,interactionState:this._interactionState,oldViewState:o,viewId:this.props.id})}}_onTransition(e){this.onViewStateChange({...e,interactionState:this._interactionState,viewId:this.props.id})}_setInteractionState(e){Object.assign(this._interactionState,e),this.onStateChange(this._interactionState)}_onPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;let i=this.isFunctionKeyPressed(e)||e.rightButton||!1;(this.invertPan||this.dragMode==="pan")&&(i=!i);const s=this.controllerState[i?"panStart":"rotateStart"]({pos:t});return this._panMove=i,this.updateViewport(s,k,{isDragging:!0}),!0}_onPan(e){return this.isDragging()?this._panMove?this._onPanMove(e):this._onPanRotate(e):!1}_onPanEnd(e){return this.isDragging()?this._panMove?this._onPanMoveEnd(e):this._onPanRotateEnd(e):!1}_onPanMove(e){if(!this.dragPan)return!1;const t=this.getCenter(e),i=this.controllerState.pan({pos:t});return this.updateViewport(i,k,{isDragging:!0,isPanning:!0}),!0}_onPanMoveEnd(e){const{inertia:t}=this;if(this.dragPan&&t&&e.velocity){const i=this.getCenter(e),s=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],n=this.controllerState.pan({pos:s}).panEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:K},{isDragging:!1,isPanning:!0})}else{const i=this.controllerState.panEnd();this.updateViewport(i,null,{isDragging:!1,isPanning:!1})}return!0}_onPanRotate(e){if(!this.dragRotate)return!1;const t=this.getCenter(e),i=this.controllerState.rotate({pos:t});return this.updateViewport(i,k,{isDragging:!0,isRotating:!0}),!0}_onPanRotateEnd(e){const{inertia:t}=this;if(this.dragRotate&&t&&e.velocity){const i=this.getCenter(e),s=[i[0]+e.velocityX*t/2,i[1]+e.velocityY*t/2],n=this.controllerState.rotate({pos:s}).rotateEnd();this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:K},{isDragging:!1,isRotating:!0})}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onWheel(e){if(!this.scrollZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;e.srcEvent.preventDefault();const{speed:i=.01,smooth:s=!1}=this.scrollZoom===!0?{}:this.scrollZoom,{delta:n}=e;let o=2/(1+Math.exp(-Math.abs(n*i)));n<0&&o!==0&&(o=1/o);const a=this.controllerState.zoom({pos:t,scale:o});return this.updateViewport(a,{...this._getTransitionProps({around:t}),transitionDuration:s?250:1},{isZooming:!0,isPanning:!0}),!0}_onMultiPanStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.rotateStart({pos:t});return this.updateViewport(i,k,{isDragging:!0}),!0}_onMultiPan(e){if(!this.touchRotate||!this.isDragging())return!1;const t=this.getCenter(e);t[0]-=e.deltaX;const i=this.controllerState.rotate({pos:t});return this.updateViewport(i,k,{isDragging:!0,isRotating:!0}),!0}_onMultiPanEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this;if(this.touchRotate&&t&&e.velocityY){const i=this.getCenter(e),s=[i[0],i[1]+=e.velocityY*t/2],n=this.controllerState.rotate({pos:s});this.updateViewport(n,{...this._getTransitionProps(),transitionDuration:t,transitionEasing:K},{isDragging:!1,isRotating:!0}),this.blockEvents(t)}else{const i=this.controllerState.rotateEnd();this.updateViewport(i,null,{isDragging:!1,isRotating:!1})}return!0}_onPinchStart(e){const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.controllerState.zoomStart({pos:t}).rotateStart({pos:t});return O._startPinchRotation=e.rotation,O._lastPinchEvent=e,this.updateViewport(i,k,{isDragging:!0}),!0}_onPinch(e){if(!this.touchZoom&&!this.touchRotate||!this.isDragging())return!1;let t=this.controllerState;if(this.touchZoom){const{scale:i}=e,s=this.getCenter(e);t=t.zoom({pos:s,scale:i})}if(this.touchRotate){const{rotation:i}=e;t=t.rotate({deltaAngleX:O._startPinchRotation-i})}return this.updateViewport(t,k,{isDragging:!0,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:this.touchRotate}),O._lastPinchEvent=e,!0}_onPinchEnd(e){if(!this.isDragging())return!1;const{inertia:t}=this,{_lastPinchEvent:i}=O;if(this.touchZoom&&t&&i&&e.scale!==i.scale){const s=this.getCenter(e);let n=this.controllerState.rotateEnd();const o=Math.log2(e.scale),a=(o-Math.log2(i.scale))/(e.deltaTime-i.deltaTime),c=Math.pow(2,o+a*t/2);n=n.zoom({pos:s,scale:c}).zoomEnd(),this.updateViewport(n,{...this._getTransitionProps({around:s}),transitionDuration:t,transitionEasing:K},{isDragging:!1,isPanning:this.touchZoom,isZooming:this.touchZoom,isRotating:!1}),this.blockEvents(t)}else{const s=this.controllerState.zoomEnd().rotateEnd();this.updateViewport(s,null,{isDragging:!1,isPanning:!1,isZooming:!1,isRotating:!1})}return O._startPinchRotation=null,O._lastPinchEvent=null,!0}_onDoubleClick(e){if(!this.doubleClickZoom)return!1;const t=this.getCenter(e);if(!this.isPointInBounds(t,e))return!1;const i=this.isFunctionKeyPressed(e),s=this.controllerState.zoom({pos:t,scale:i?.5:2});return this.updateViewport(s,this._getTransitionProps({around:t}),{isZooming:!0,isPanning:!0}),this.blockEvents(100),!0}_onKeyDown(e){if(!this.keyboard)return!1;const t=this.isFunctionKeyPressed(e),{zoomSpeed:i,moveSpeed:s,rotateSpeedX:n,rotateSpeedY:o}=this.keyboard===!0?{}:this.keyboard,{controllerState:a}=this;let c;const h={};switch(e.srcEvent.code){case"Minus":c=t?a.zoomOut(i).zoomOut(i):a.zoomOut(i),h.isZooming=!0;break;case"Equal":c=t?a.zoomIn(i).zoomIn(i):a.zoomIn(i),h.isZooming=!0;break;case"ArrowLeft":t?(c=a.rotateLeft(n),h.isRotating=!0):(c=a.moveLeft(s),h.isPanning=!0);break;case"ArrowRight":t?(c=a.rotateRight(n),h.isRotating=!0):(c=a.moveRight(s),h.isPanning=!0);break;case"ArrowUp":t?(c=a.rotateUp(o),h.isRotating=!0):(c=a.moveUp(s),h.isPanning=!0);break;case"ArrowDown":t?(c=a.rotateDown(o),h.isRotating=!0):(c=a.moveDown(s),h.isPanning=!0);break;default:return!1}return this.updateViewport(c,this._getTransitionProps(),h),!0}_getTransitionProps(e){const{transition:t}=this;return!t||!t.transitionInterpolator?k:e?{...t,transitionInterpolator:new be({...e,...t.transitionInterpolator.opts,makeViewport:this.controllerState.makeViewport})}:t}}class pn{constructor(e,t){this._viewportProps=this.applyConstraints(e),this._state=t}getViewportProps(){return this._viewportProps}getState(){return this._state}}const Ye=5,fn=1.2;class gt extends pn{constructor(e){const{width:t,height:i,latitude:s,longitude:n,zoom:o,bearing:a=0,pitch:c=0,altitude:h=1.5,position:l=[0,0,0],maxZoom:u=20,minZoom:d=0,maxPitch:p=60,minPitch:g=0,startPanLngLat:f,startZoomLngLat:m,startRotatePos:v,startBearing:_,startPitch:P,startZoom:L,normalize:A=!0}=e;M(Number.isFinite(n)),M(Number.isFinite(s)),M(Number.isFinite(o)),super({width:t,height:i,latitude:s,longitude:n,zoom:o,bearing:a,pitch:c,altitude:h,maxZoom:u,minZoom:d,maxPitch:p,minPitch:g,normalize:A,position:l},{startPanLngLat:f,startZoomLngLat:m,startRotatePos:v,startBearing:_,startPitch:P,startZoom:L}),this.makeViewport=e.makeViewport}panStart({pos:e}){return this._getUpdatedState({startPanLngLat:this._unproject(e)})}pan({pos:e,startPos:t}){const i=this.getState().startPanLngLat||this._unproject(t);if(!i)return this;const n=this.makeViewport(this.getViewportProps()).panByPosition(i,e);return this._getUpdatedState(n)}panEnd(){return this._getUpdatedState({startPanLngLat:null})}rotateStart({pos:e}){return this._getUpdatedState({startRotatePos:e,startBearing:this.getViewportProps().bearing,startPitch:this.getViewportProps().pitch})}rotate({pos:e,deltaAngleX:t=0,deltaAngleY:i=0}){const{startRotatePos:s,startBearing:n,startPitch:o}=this.getState();if(!s||n===void 0||o===void 0)return this;let a;return e?a=this._getNewRotation(e,s,o,n):a={bearing:n+t,pitch:o+i},this._getUpdatedState(a)}rotateEnd(){return this._getUpdatedState({startBearing:null,startPitch:null})}zoomStart({pos:e}){return this._getUpdatedState({startZoomLngLat:this._unproject(e),startZoom:this.getViewportProps().zoom})}zoom({pos:e,startPos:t,scale:i}){let{startZoom:s,startZoomLngLat:n}=this.getState();if(n||(s=this.getViewportProps().zoom,n=this._unproject(t)||this._unproject(e)),!n)return this;const{maxZoom:o,minZoom:a}=this.getViewportProps();let c=s+Math.log2(i);c=U(c,a,o);const h=this.makeViewport({...this.getViewportProps(),zoom:c});return this._getUpdatedState({zoom:c,...h.panByPosition(n,e)})}zoomEnd(){return this._getUpdatedState({startZoomLngLat:null,startZoom:null})}zoomIn(e=2){return this._zoomFromCenter(e)}zoomOut(e=2){return this._zoomFromCenter(1/e)}moveLeft(e=100){return this._panFromCenter([e,0])}moveRight(e=100){return this._panFromCenter([-e,0])}moveUp(e=100){return this._panFromCenter([0,e])}moveDown(e=100){return this._panFromCenter([0,-e])}rotateLeft(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing-e})}rotateRight(e=15){return this._getUpdatedState({bearing:this.getViewportProps().bearing+e})}rotateUp(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch+e})}rotateDown(e=10){return this._getUpdatedState({pitch:this.getViewportProps().pitch-e})}shortestPathFrom(e){const t=e.getViewportProps(),i={...this.getViewportProps()},{bearing:s,longitude:n}=i;return Math.abs(s-t.bearing)>180&&(i.bearing=s<0?s+360:s-360),Math.abs(n-t.longitude)>180&&(i.longitude=n<0?n+360:n-360),i}applyConstraints(e){const{maxZoom:t,minZoom:i,zoom:s}=e;e.zoom=U(s,i,t);const{maxPitch:n,minPitch:o,pitch:a}=e;e.pitch=U(a,o,n);const{normalize:c=!0}=e;return c&&Object.assign(e,us(e)),e}_zoomFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.zoom({pos:[t/2,i/2],scale:e})}_panFromCenter(e){const{width:t,height:i}=this.getViewportProps();return this.pan({startPos:[t/2,i/2],pos:[t/2+e[0],i/2+e[1]]})}_getUpdatedState(e){return new this.constructor({makeViewport:this.makeViewport,...this.getViewportProps(),...this.getState(),...e})}_unproject(e){const t=this.makeViewport(this.getViewportProps());return e&&t.unproject(e)}_getNewRotation(e,t,i,s){const n=e[0]-t[0],o=e[1]-t[1],a=e[1],c=t[1],{width:h,height:l}=this.getViewportProps(),u=n/h;let d=0;o>0?Math.abs(l-c)>Ye&&(d=o/(c-l)*fn):o<0&&c>Ye&&(d=1-a/c),d=U(d,-1,1);const{minPitch:p,maxPitch:g}=this.getViewportProps(),f=s+180*u;let m=i;return d>0?m=i+d*(g-i):d<0&&(m=i-d*(p-i)),{pitch:m,bearing:f}}}class gn extends ft{constructor(){super(...arguments),this.ControllerState=gt,this.transition={transitionDuration:300,transitionInterpolator:new be({transitionProps:{compare:["longitude","latitude","zoom","bearing","pitch","position"],required:["longitude","latitude","zoom"]}})},this.dragMode="pan"}setProps(e){e.position=e.position||[0,0,0];const t=this.props;super.setProps(e),(!t||t.height!==e.height)&&this.updateViewport(new this.ControllerState({makeViewport:this.makeViewport,...e,...this.state}))}}class Pe extends pt{constructor(e={}){super(e)}getViewportType(){return nt}get ControllerType(){return gn}}Pe.displayName="MapView";const mn=new lt;function wn(r,e){const t=r.order??1/0,i=e.order??1/0;return t-i}class _n{constructor(e){this._resolvedEffects=[],this._defaultEffects=[],this.effects=[],this._context=e,this._needsRedraw="Initial render",this._setEffects([])}addDefaultEffect(e){const t=this._defaultEffects;if(!t.find(i=>i.id===e.id)){const i=t.findIndex(s=>wn(s,e)>0);i<0?t.push(e):t.splice(i,0,e),e.setup(this._context),this._setEffects(this.effects)}}setProps(e){"effects"in e&&($(e.effects,this.effects,1)||this._setEffects(e.effects))}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}getEffects(){return this._resolvedEffects}_setEffects(e){const t={};for(const s of this.effects)t[s.id]=s;const i=[];for(const s of e){const n=t[s.id];let o=s;n&&n!==s?n.setProps?(n.setProps(s.props),o=n):n.cleanup(this._context):n||s.setup(this._context),i.push(o),delete t[s.id]}for(const s in t)t[s].cleanup(this._context);this.effects=i,this._resolvedEffects=i.concat(this._defaultEffects),e.some(s=>s instanceof lt)||this._resolvedEffects.push(mn),this._needsRedraw="effects changed"}finalize(){for(const e of this._resolvedEffects)e.cleanup(this._context);this.effects.length=0,this._resolvedEffects.length=0,this._defaultEffects.length=0}}class vn extends Ee{shouldDrawLayer(e){const{operation:t}=e.props;return t.includes("draw")||t.includes("terrain")}}const yn="deckRenderer.renderLayers";class En{constructor(e){this.device=e,this.layerFilter=null,this.drawPickingColors=!1,this.drawLayersPass=new vn(e),this.pickLayersPass=new ut(e),this.renderCount=0,this._needsRedraw="Initial render",this.renderBuffers=[],this.lastPostProcessEffect=null}setProps(e){this.layerFilter!==e.layerFilter&&(this.layerFilter=e.layerFilter,this._needsRedraw="layerFilter changed"),this.drawPickingColors!==e.drawPickingColors&&(this.drawPickingColors=e.drawPickingColors,this._needsRedraw="drawPickingColors changed")}renderLayers(e){if(!e.viewports.length)return;const t=this.drawPickingColors?this.pickLayersPass:this.drawLayersPass,i={layerFilter:this.layerFilter,isPicking:this.drawPickingColors,...e};i.effects&&this._preRender(i.effects,i);const s=this.lastPostProcessEffect?this.renderBuffers[0]:i.target;this.lastPostProcessEffect&&(i.clearColor=[0,0,0,0],i.clearCanvas=!0);const n=t.render({...i,target:s});i.effects&&this._postRender(i.effects,i),this.renderCount++,ae(yn,this,n,e)}needsRedraw(e={clearRedrawFlags:!1}){const t=this._needsRedraw;return e.clearRedrawFlags&&(this._needsRedraw=!1),t}finalize(){const{renderBuffers:e}=this;for(const t of e)t.delete();e.length=0}_preRender(e,t){this.lastPostProcessEffect=null,t.preRenderStats=t.preRenderStats||{};for(const i of e)t.preRenderStats[i.id]=i.preRender(t),i.postRender&&(this.lastPostProcessEffect=i.id);this.lastPostProcessEffect&&this._resizeRenderBuffers()}_resizeRenderBuffers(){const{renderBuffers:e}=this,t=this.device.canvasContext.getDrawingBufferSize();e.length===0&&[0,1].map(i=>{const s=this.device.createTexture({sampler:{minFilter:"linear",magFilter:"linear"}});e.push(this.device.createFramebuffer({id:`deck-renderbuffer-${i}`,colorAttachments:[s]}))});for(const i of e)i.resize(t)}_postRender(e,t){const{renderBuffers:i}=this,s={...t,inputBuffer:i[0],swapBuffer:i[1]};for(const n of e)if(n.postRender){s.target=n.id===this.lastPostProcessEffect?t.target:void 0;const o=n.postRender(s);s.inputBuffer=o,s.swapBuffer=o===i[0]?i[1]:i[0]}}}const bn={pickedColor:null,pickedObjectIndex:-1};function Pn({pickedColors:r,decodePickingColor:e,deviceX:t,deviceY:i,deviceRadius:s,deviceRect:n}){const{x:o,y:a,width:c,height:h}=n;let l=s*s,u=-1,d=0;for(let p=0;p<h;p++){const g=p+a-i,f=g*g;if(f>l)d+=4*c;else for(let m=0;m<c;m++){if(r[d+3]-1>=0){const _=m+o-t,P=_*_+f;P<=l&&(l=P,u=d)}d+=4}}if(u>=0){const p=r.slice(u,u+4),g=e(p);if(g){const f=Math.floor(u/4/c),m=u/4-f*c;return{...g,pickedColor:p,pickedX:o+m,pickedY:a+f}}y.error("Picked non-existent layer. Is picking buffer corrupt?")()}return bn}function Sn({pickedColors:r,decodePickingColor:e}){const t=new Map;if(r){for(let i=0;i<r.length;i+=4)if(r[i+3]-1>=0){const n=r.slice(i,i+4),o=n.join(",");if(!t.has(o)){const a=e(n);a?t.set(o,{...a,color:n}):y.error("Picked non-existent layer. Is picking buffer corrupt?")()}}}return Array.from(t.values())}function mt({pickInfo:r,viewports:e,pixelRatio:t,x:i,y:s,z:n}){let o=e[0];e.length>1&&(o=Tn((r==null?void 0:r.pickedViewports)||e,{x:i,y:s}));let a;if(o){const c=[i-o.x,s-o.y];n!==void 0&&(c[2]=n),a=o.unproject(c)}return{color:null,layer:null,viewport:o,index:-1,picked:!1,x:i,y:s,pixel:[i,s],coordinate:a,devicePixel:r&&"pickedX"in r?[r.pickedX,r.pickedY]:void 0,pixelRatio:t}}function Mn(r){const{pickInfo:e,lastPickedInfo:t,mode:i,layers:s}=r,{pickedColor:n,pickedLayer:o,pickedObjectIndex:a}=e,c=o?[o]:[];if(i==="hover"){const u=t.index,d=t.layerId,p=o?o.props.id:null;if(p!==d||a!==u){if(p!==d){const g=s.find(f=>f.props.id===d);g&&c.unshift(g)}t.layerId=p,t.index=a,t.info=null}}const h=mt(r),l=new Map;return l.set(null,h),c.forEach(u=>{let d={...h};u===o&&(d.color=n,d.index=a,d.picked=!0),d=wt({layer:u,info:d,mode:i});const p=d.layer;u===o&&i==="hover"&&(t.info=d),l.set(p.id,d),i==="hover"&&p.updateAutoHighlight(d)}),l}function wt({layer:r,info:e,mode:t}){for(;r&&e;){const i=e.layer||null;e.sourceLayer=i,e.layer=r,e=r.getPickingInfo({info:e,mode:t,sourceLayer:i}),r=r.parent}return e}function Tn(r,e){for(let t=r.length-1;t>=0;t--){const i=r[t];if(i.containsPixel(e))return i}return r[0]}class Cn{constructor(e){this._pickable=!0,this.device=e,this.pickLayersPass=new ut(e),this.lastPickedInfo={index:-1,layerId:null,info:null}}setProps(e){"layerFilter"in e&&(this.layerFilter=e.layerFilter),"_pickable"in e&&(this._pickable=e._pickable)}finalize(){this.pickingFBO&&this.pickingFBO.destroy(),this.depthFBO&&this.depthFBO.destroy()}pickObject(e){return this._pickClosestObject(e)}pickObjects(e){return this._pickVisibleObjects(e)}getLastPickedObject({x:e,y:t,layers:i,viewports:s},n=this.lastPickedInfo.info){const o=n&&n.layer&&n.layer.id,a=n&&n.viewport&&n.viewport.id,c=o?i.find(d=>d.id===o):null,h=a&&s.find(d=>d.id===a)||s[0],l=h&&h.unproject([e-h.x,t-h.y]);return{...n,...{x:e,y:t,viewport:h,coordinate:l,layer:c}}}_resizeBuffer(){var t,i;if(!this.pickingFBO&&(this.pickingFBO=this.device.createFramebuffer({colorAttachments:["rgba8unorm"],depthStencilAttachment:"depth16unorm"}),this.device.isTextureFormatRenderable("rgba32float"))){const s=this.device.createFramebuffer({colorAttachments:["rgba32float"],depthStencilAttachment:"depth16unorm"});this.depthFBO=s}const{canvas:e}=this.device.getDefaultCanvasContext();(t=this.pickingFBO)==null||t.resize({width:e.width,height:e.height}),(i=this.depthFBO)==null||i.resize({width:e.width,height:e.height})}_getPickable(e){if(this._pickable===!1)return null;const t=e.filter(i=>this.pickLayersPass.shouldDrawLayer(i)&&!i.isComposite);return t.length?t:null}_pickClosestObject({layers:e,views:t,viewports:i,x:s,y:n,radius:o=0,depth:a=1,mode:c="query",unproject3D:h,onViewportActive:l,effects:u}){const d=this.device.canvasContext.cssToDeviceRatio(),p=this._getPickable(e);if(!p||i.length===0)return{result:[],emptyInfo:mt({viewports:i,x:s,y:n,pixelRatio:d})};this._resizeBuffer();const g=this.device.canvasContext.cssToDevicePixels([s,n],!0),f=[g.x+Math.floor(g.width/2),g.y+Math.floor(g.height/2)],m=Math.round(o*d),{width:v,height:_}=this.pickingFBO,P=this._getPickingRect({deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceWidth:v,deviceHeight:_}),L={x:s-o,y:n-o,width:o*2+1,height:o*2+1};let A;const j=[],V=new Set;for(let C=0;C<a;C++){let E;if(P){const S=this._drawAndSample({layers:p,views:t,viewports:i,onViewportActive:l,deviceRect:P,cullRect:L,effects:u,pass:`picking:${c}`});E=Pn({...S,deviceX:f[0],deviceY:f[1],deviceRadius:m,deviceRect:P})}else E={pickedColor:null,pickedObjectIndex:-1};let z;if(E.pickedLayer&&h&&this.depthFBO){const{pickedColors:S}=this._drawAndSample({layers:[E.pickedLayer],views:t,viewports:i,onViewportActive:l,deviceRect:{x:E.pickedX,y:E.pickedY,width:1,height:1},cullRect:L,effects:u,pass:`picking:${c}:z`},!0);S[3]&&(z=S[0])}E.pickedLayer&&C+1<a&&(V.add(E.pickedLayer),E.pickedLayer.disablePickingIndex(E.pickedObjectIndex)),A=Mn({pickInfo:E,lastPickedInfo:this.lastPickedInfo,mode:c,layers:p,viewports:i,x:s,y:n,z,pixelRatio:d});for(const S of A.values())S.layer&&j.push(S);if(!E.pickedColor)break}for(const C of V)C.restorePickingColors();return{result:j,emptyInfo:A.get(null)}}_pickVisibleObjects({layers:e,views:t,viewports:i,x:s,y:n,width:o=1,height:a=1,mode:c="query",maxObjects:h=null,onViewportActive:l,effects:u}){const d=this._getPickable(e);if(!d||i.length===0)return[];this._resizeBuffer();const p=this.device.canvasContext.cssToDeviceRatio(),g=this.device.canvasContext.cssToDevicePixels([s,n],!0),f=g.x,m=g.y+g.height,v=this.device.canvasContext.cssToDevicePixels([s+o,n+a],!0),_=v.x+v.width,P=v.y,L={x:f,y:P,width:_-f,height:m-P},A=this._drawAndSample({layers:d,views:t,viewports:i,onViewportActive:l,deviceRect:L,cullRect:{x:s,y:n,width:o,height:a},effects:u,pass:`picking:${c}`}),j=Sn(A),V=new Map,C=[],E=Number.isFinite(h);for(let z=0;z<j.length&&!(E&&C.length>=h);z++){const S=j[z];let F={color:S.pickedColor,layer:null,index:S.pickedObjectIndex,picked:!0,x:s,y:n,pixelRatio:p};F=wt({layer:S.pickedLayer,info:F,mode:c});const se=F.layer.id;V.has(se)||V.set(se,new Set);const Me=V.get(se),Te=F.object??F.index;Me.has(Te)||(Me.add(Te),C.push(F))}return C}_drawAndSample({layers:e,views:t,viewports:i,onViewportActive:s,deviceRect:n,cullRect:o,effects:a,pass:c},h=!1){const l=h?this.depthFBO:this.pickingFBO,u={layers:e,layerFilter:this.layerFilter,views:t,viewports:i,onViewportActive:s,pickingFBO:l,deviceRect:n,cullRect:o,effects:a,pass:c,pickZ:h,preRenderStats:{},isPicking:!0};for(const _ of a)_.useInPicking&&(u.preRenderStats[_.id]=_.preRender(u));const{decodePickingColor:d}=this.pickLayersPass.render(u),{x:p,y:g,width:f,height:m}=n,v=new(h?Float32Array:Uint8Array)(f*m*4);return this.device.readPixelsToArrayWebGL(l,{sourceX:p,sourceY:g,sourceWidth:f,sourceHeight:m,target:v}),{pickedColors:v,decodePickingColor:d}}_getPickingRect({deviceX:e,deviceY:t,deviceRadius:i,deviceWidth:s,deviceHeight:n}){const o=Math.max(0,e-i),a=Math.max(0,t-i),c=Math.min(s,e+i+1)-o,h=Math.min(n,t+i+1)-a;return c<=0||h<=0?null:{x:o,y:a,width:c,height:h}}}const Ln={"top-left":{top:0,left:0},"top-right":{top:0,right:0},"bottom-left":{bottom:0,left:0},"bottom-right":{bottom:0,right:0},fill:{top:0,left:0,bottom:0,right:0}},Rn="top-left",Ke="__root";class xn{constructor({deck:e,parentElement:t}){this.defaultWidgets=[],this.widgets=[],this.resolvedWidgets=[],this.containers={},this.lastViewports={},this.deck=e,this.parentElement=t}getWidgets(){return this.resolvedWidgets}setProps(e){e.widgets&&!$(e.widgets,this.widgets,1)&&this._setWidgets(e.widgets)}finalize(){for(const e of this.getWidgets())this._remove(e);this.defaultWidgets.length=0,this.resolvedWidgets.length=0;for(const e in this.containers)this.containers[e].remove()}addDefault(e){this.defaultWidgets.find(t=>t.id===e.id)||(this._add(e),this.defaultWidgets.push(e),this._setWidgets(this.widgets))}_setWidgets(e){const t={};for(const i of this.resolvedWidgets)t[i.id]=i;this.resolvedWidgets.length=0;for(const i of this.defaultWidgets)t[i.id]=null,this.resolvedWidgets.push(i);for(let i of e){const s=t[i.id];s?s.viewId!==i.viewId||s.placement!==i.placement?(this._remove(s),this._add(i)):i!==s&&(s.setProps(i.props),i=s):this._add(i),t[i.id]=null,this.resolvedWidgets.push(i)}for(const i in t){const s=t[i];s&&this._remove(s)}this.widgets=e}_add(e){const{viewId:t=null,placement:i=Rn}=e,s=e.onAdd({deck:this.deck,viewId:t});s&&this._getContainer(t,i).append(s),e._element=s}_remove(e){var t;(t=e.onRemove)==null||t.call(e),e._element&&e._element.remove(),e._element=void 0}_getContainer(e,t){var o;const i=e||Ke;let s=this.containers[i];s||(s=document.createElement("div"),s.style.pointerEvents="none",s.style.position="absolute",s.style.overflow="hidden",(o=this.parentElement)==null||o.append(s),this.containers[i]=s);let n=s.querySelector(`.${t}`);return n||(n=document.createElement("div"),n.className=t,n.style.position="absolute",n.style.zIndex="2",Object.assign(n.style,Ln[t]),s.append(n)),n}_updateContainers(){const e=this.deck.width,t=this.deck.height;for(const i in this.containers){const s=this.lastViewports[i]||null,n=i===Ke||s,o=this.containers[i];n?(o.style.display="block",o.style.left=`${s?s.x:0}px`,o.style.top=`${s?s.y:0}px`,o.style.width=`${s?s.width:e}px`,o.style.height=`${s?s.height:t}px`):o.style.display="none"}}onRedraw({viewports:e,layers:t}){var s,n;const i=e.reduce((o,a)=>(o[a.id]=a,o),{});for(const o of this.getWidgets()){const{viewId:a}=o;if(a){const c=i[a];c&&(o.onViewportChange&&o.onViewportChange(c),(s=o.onRedraw)==null||s.call(o,{viewports:[c],layers:t}))}else{if(o.onViewportChange)for(const c of e)o.onViewportChange(c);(n=o.onRedraw)==null||n.call(o,{viewports:e,layers:t})}}this.lastViewports=i,this._updateContainers()}onHover(e,t){var i,s;for(const n of this.getWidgets()){const{viewId:o}=n;(!o||o===((i=e.viewport)==null?void 0:i.id))&&((s=n.onHover)==null||s.call(n,e,t))}}onEvent(e,t){var s,n;const i=ce[t.type];if(i)for(const o of this.getWidgets()){const{viewId:a}=o;(!a||a===((s=e.viewport)==null?void 0:s.id))&&((n=o[i])==null||n.call(o,e,t))}}}const kn={zIndex:"1",position:"absolute",pointerEvents:"none",color:"#a0a7b4",backgroundColor:"#29323c",padding:"10px",top:"0",left:"0",display:"none"};class In{constructor(){this.id="default-tooltip",this.placement="fill",this.props={},this.isVisible=!1}onAdd({deck:e}){const t=document.createElement("div");return t.className="deck-tooltip",Object.assign(t.style,kn),this.deck=e,this.element=t,t}onRemove(){this.deck=void 0,this.element=void 0}setProps(){}onViewportChange(e){var t;this.isVisible&&e.id===((t=this.lastViewport)==null?void 0:t.id)&&e!==this.lastViewport&&this.setTooltip(null)}onHover(e){const{deck:t}=this,i=t&&t.props.getTooltip;if(!i)return;const s=i(e);this.lastViewport=e.viewport,this.setTooltip(s,e.x,e.y)}setTooltip(e,t,i){const s=this.element;if(s){if(typeof e=="string")s.innerText=e;else if(e)e.text&&(s.innerText=e.text),e.html&&(s.innerHTML=e.html),e.className&&(s.className=e.className);else{this.isVisible=!1,s.style.display="none";return}this.isVisible=!0,s.style.display="block",s.style.transform=`translate(${t}px, ${i}px)`,e&&typeof e=="object"&&"style"in e&&Object.assign(s.style,e.style)}}}const Dn={WEBGL_depth_texture:{UNSIGNED_INT_24_8_WEBGL:34042},OES_element_index_uint:{},OES_texture_float:{},OES_texture_half_float:{HALF_FLOAT_OES:5131},EXT_color_buffer_float:{},OES_standard_derivatives:{FRAGMENT_SHADER_DERIVATIVE_HINT_OES:35723},EXT_frag_depth:{},EXT_blend_minmax:{MIN_EXT:32775,MAX_EXT:32776},EXT_shader_texture_lod:{}},An=r=>({drawBuffersWEBGL(e){return r.drawBuffers(e)},COLOR_ATTACHMENT0_WEBGL:36064,COLOR_ATTACHMENT1_WEBGL:36065,COLOR_ATTACHMENT2_WEBGL:36066,COLOR_ATTACHMENT3_WEBGL:36067}),On=r=>({VERTEX_ARRAY_BINDING_OES:34229,createVertexArrayOES(){return r.createVertexArray()},deleteVertexArrayOES(e){return r.deleteVertexArray(e)},isVertexArrayOES(e){return r.isVertexArray(e)},bindVertexArrayOES(e){return r.bindVertexArray(e)}}),Vn=r=>({VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE:35070,drawArraysInstancedANGLE(...e){return r.drawArraysInstanced(...e)},drawElementsInstancedANGLE(...e){return r.drawElementsInstanced(...e)},vertexAttribDivisorANGLE(...e){return r.vertexAttribDivisor(...e)}});function zn(r=!0){const e=HTMLCanvasElement.prototype;if(!r&&e.originalGetContext){e.getContext=e.originalGetContext,e.originalGetContext=void 0;return}e.originalGetContext=e.getContext,e.getContext=function(t,i){if(t==="webgl"||t==="experimental-webgl"){const s=this.originalGetContext("webgl2",i);return s instanceof HTMLElement&&Fn(s),s}return this.originalGetContext(t,i)}}function Fn(r){r.getExtension("EXT_color_buffer_float");const e={...Dn,WEBGL_disjoint_timer_query:r.getExtension("EXT_disjoint_timer_query_webgl2"),WEBGL_draw_buffers:An(r),OES_vertex_array_object:On(r),ANGLE_instanced_arrays:Vn(r)},t=r.getExtension;r.getExtension=function(s){const n=t.call(r,s);return n||(s in e?e[s]:null)};const i=r.getSupportedExtensions;r.getSupportedExtensions=function(){const s=i.apply(r)||[];return s==null?void 0:s.concat(Object.keys(e))}}const J=1;class Nn extends Bi{constructor(){super();w(this,"type","webgl");ee.defaultProps={...ee.defaultProps,...Ht},Y.adapter=this}isSupported(){return typeof WebGL2RenderingContext<"u"}enforceWebGL2(t){zn(t)}async attach(t){if(t instanceof Y)return t;if((t==null?void 0:t.device)instanceof ee)return t.device;if(!Un(t))throw new Error("Invalid WebGL2RenderingContext");return new Y({_handle:t,createCanvasContext:{canvas:t.canvas,autoResize:!1}})}async create(t={}){b.groupCollapsed(J,"WebGLDevice created")();const i=[];(t.debugWebGL||t.debug)&&i.push(Zt()),t.debugSpectorJS&&i.push($t(t));const s=await Promise.allSettled(i);for(const a of s)a.status==="rejected"&&b.error(`Failed to initialize debug libraries ${a.reason}`)();const n=new Y(t),o=`${n._reused?"Reusing":"Created"} device with WebGL2 ${n.debug?"debug ":""}context: ${n.info.vendor}, ${n.info.renderer} for canvas: ${n.canvasContext.id}`;return b.probe(J,o)(),b.table(J,n.info)(),b.groupEnd(J)(),n}}function Un(r){return typeof WebGL2RenderingContext<"u"&&r instanceof WebGL2RenderingContext?!0:!!(r&&Number.isFinite(r._version))}const Je=new Nn;function I(){}const jn=({isDragging:r})=>r?"grabbing":"grab",_t={id:"",width:"100%",height:"100%",style:null,viewState:null,initialViewState:null,pickingRadius:0,layerFilter:null,parameters:{},parent:null,device:null,deviceProps:{},gl:null,canvas:null,layers:[],effects:[],views:null,controller:null,useDevicePixels:!0,touchAction:"none",eventRecognizerOptions:{},_framebuffer:null,_animate:!1,_pickable:!0,_typedArrayManagerProps:{},_customRender:null,widgets:[],onDeviceInitialized:I,onWebGLInitialized:I,onResize:I,onViewStateChange:I,onInteractionStateChange:I,onBeforeRender:I,onAfterRender:I,onLoad:I,onError:r=>y.error(r.message,r.cause)(),onHover:null,onClick:null,onDragStart:null,onDrag:null,onDragEnd:null,_onMetrics:null,getCursor:jn,getTooltip:null,debug:!1,drawPickingColors:!1};class H{constructor(e){this.width=0,this.height=0,this.userData={},this.device=null,this.canvas=null,this.viewManager=null,this.layerManager=null,this.effectManager=null,this.deckRenderer=null,this.deckPicker=null,this.eventManager=null,this.widgetManager=null,this.tooltip=null,this.animationLoop=null,this.cursorState={isHovering:!1,isDragging:!1},this.stats=new ve({id:"deck.gl"}),this.metrics={fps:0,setPropsTime:0,updateAttributesTime:0,framesRedrawn:0,pickTime:0,pickCount:0,gpuTime:0,gpuTimePerFrame:0,cpuTime:0,cpuTimePerFrame:0,bufferMemory:0,textureMemory:0,renderbufferMemory:0,gpuMemory:0},this._metricsCounter=0,this._needsRedraw="Initial render",this._pickRequest={mode:"hover",x:-1,y:-1,radius:0,event:null},this._lastPointerDownInfo=null,this._onPointerMove=i=>{const{_pickRequest:s}=this;if(i.type==="pointerleave")s.x=-1,s.y=-1,s.radius=0;else{if(i.leftButton||i.rightButton)return;{const n=i.offsetCenter;if(!n)return;s.x=n.x,s.y=n.y,s.radius=this.props.pickingRadius}}this.layerManager&&(this.layerManager.context.mousePosition={x:s.x,y:s.y}),s.event=i},this._onEvent=i=>{const s=ce[i.type],n=i.offsetCenter;if(!s||!n||!this.layerManager)return;const o=this.layerManager.getLayers(),a=this.deckPicker.getLastPickedObject({x:n.x,y:n.y,layers:o,viewports:this.getViewports(n)},this._lastPointerDownInfo),{layer:c}=a,h=c&&(c[s]||c.props[s]),l=this.props[s];let u=!1;h&&(u=h.call(c,a,i)),u||(l==null||l(a,i),this.widgetManager.onEvent(a,i))},this._onPointerDown=i=>{var o;if(((o=this.device)==null?void 0:o.type)==="webgpu")return;const s=i.offsetCenter,n=this._pick("pickObject","pickObject Time",{x:s.x,y:s.y,radius:this.props.pickingRadius});this._lastPointerDownInfo=n.result[0]||n.emptyInfo},this.props={..._t,...e},e=this.props,e.viewState&&e.initialViewState&&y.warn("View state tracking is disabled. Use either `initialViewState` for auto update or `viewState` for manual update.")(),this.viewState=this.props.initialViewState,e.device&&(this.device=e.device);let t=this.device;!t&&e.gl&&(e.gl instanceof WebGLRenderingContext&&y.error("WebGL1 context not supported.")(),t=Je.attach(e.gl)),t||(t=pe.createDevice({type:"best-available",_reuseDevices:!0,adapters:[Je],...e.deviceProps,createCanvasContext:{canvas:this._createCanvas(e),useDevicePixels:this.props.useDevicePixels,autoResize:!1}})),this.animationLoop=this._createAnimationLoop(t,e),this.setProps(e),e._typedArrayManagerProps&&qt.setOptions(e._typedArrayManagerProps),this.animationLoop.start()}finalize(){var e,t,i,s,n,o,a,c,h,l;(e=this.animationLoop)==null||e.stop(),(t=this.animationLoop)==null||t.destroy(),this.animationLoop=null,this._lastPointerDownInfo=null,(i=this.layerManager)==null||i.finalize(),this.layerManager=null,(s=this.viewManager)==null||s.finalize(),this.viewManager=null,(n=this.effectManager)==null||n.finalize(),this.effectManager=null,(o=this.deckRenderer)==null||o.finalize(),this.deckRenderer=null,(a=this.deckPicker)==null||a.finalize(),this.deckPicker=null,(c=this.eventManager)==null||c.destroy(),this.eventManager=null,(h=this.widgetManager)==null||h.finalize(),this.widgetManager=null,!this.props.canvas&&!this.props.device&&!this.props.gl&&this.canvas&&((l=this.canvas.parentElement)==null||l.removeChild(this.canvas),this.canvas=null)}setProps(e){var i;this.stats.get("setProps Time").timeStart(),"onLayerHover"in e&&y.removed("onLayerHover","onHover")(),"onLayerClick"in e&&y.removed("onLayerClick","onClick")(),e.initialViewState&&!$(this.props.initialViewState,e.initialViewState,3)&&(this.viewState=e.initialViewState),Object.assign(this.props,e),this._setCanvasSize(this.props);const t=Object.create(this.props);Object.assign(t,{views:this._getViews(),width:this.width,height:this.height,viewState:this._getViewState()}),(i=this.animationLoop)==null||i.setProps(t),this.layerManager&&(this.viewManager.setProps(t),this.layerManager.activateViewport(this.getViewports()[0]),this.layerManager.setProps(t),this.effectManager.setProps(t),this.deckRenderer.setProps(t),this.deckPicker.setProps(t),this.widgetManager.setProps(t)),this.stats.get("setProps Time").timeEnd()}needsRedraw(e={clearRedrawFlags:!1}){if(!this.layerManager)return!1;if(this.props._animate)return"Deck._animate";let t=this._needsRedraw;e.clearRedrawFlags&&(this._needsRedraw=!1);const i=this.viewManager.needsRedraw(e),s=this.layerManager.needsRedraw(e),n=this.effectManager.needsRedraw(e),o=this.deckRenderer.needsRedraw(e);return t=t||i||s||n||o,t}redraw(e){if(!this.layerManager)return;let t=this.needsRedraw({clearRedrawFlags:!0});t=e||t,t&&(this.stats.get("Redraw Count").incrementCount(),this.props._customRender?this.props._customRender(t):this._drawLayers(t))}get isInitialized(){return this.viewManager!==null}getViews(){return M(this.viewManager),this.viewManager.views}getViewports(e){return M(this.viewManager),this.viewManager.getViewports(e)}getCanvas(){return this.canvas}pickObject(e){const t=this._pick("pickObject","pickObject Time",e).result;return t.length?t[0]:null}pickMultipleObjects(e){return e.depth=e.depth||10,this._pick("pickObject","pickMultipleObjects Time",e).result}pickObjects(e){return this._pick("pickObjects","pickObjects Time",e)}_addResources(e,t=!1){for(const i in e)this.layerManager.resourceManager.add({resourceId:i,data:e[i],forceUpdate:t})}_removeResources(e){for(const t of e)this.layerManager.resourceManager.remove(t)}_addDefaultEffect(e){this.effectManager.addDefaultEffect(e)}_addDefaultShaderModule(e){this.layerManager.addDefaultShaderModule(e)}_removeDefaultShaderModule(e){var t;(t=this.layerManager)==null||t.removeDefaultShaderModule(e)}_pick(e,t,i){M(this.deckPicker);const{stats:s}=this;s.get("Pick Count").incrementCount(),s.get(t).timeStart();const n=this.deckPicker[e]({layers:this.layerManager.getLayers(i),views:this.viewManager.getViews(),viewports:this.getViewports(i),onViewportActive:this.layerManager.activateViewport,effects:this.effectManager.getEffects(),...i});return s.get(t).timeEnd(),n}_createCanvas(e){let t=e.canvas;return typeof t=="string"&&(t=document.getElementById(t),M(t)),t||(t=document.createElement("canvas"),t.id=e.id||"deckgl-overlay",(e.parent||document.body).appendChild(t)),Object.assign(t.style,e.style),t}_setCanvasSize(e){var s;if(!this.canvas)return;const{width:t,height:i}=e;if(t||t===0){const n=Number.isFinite(t)?`${t}px`:t;this.canvas.style.width=n}if(i||i===0){const n=Number.isFinite(i)?`${i}px`:i;this.canvas.style.position=((s=e.style)==null?void 0:s.position)||"absolute",this.canvas.style.height=n}}_updateCanvasSize(){var s,n;const{canvas:e}=this;if(!e)return;const t=e.clientWidth??e.width,i=e.clientHeight??e.height;(t!==this.width||i!==this.height)&&(this.width=t,this.height=i,(s=this.viewManager)==null||s.setProps({width:t,height:i}),(n=this.layerManager)==null||n.activateViewport(this.getViewports()[0]),this.props.onResize({width:t,height:i}))}_createAnimationLoop(e,t){const{gl:i,onError:s,useDevicePixels:n}=t;return new qs({device:e,useDevicePixels:n,autoResizeDrawingBuffer:!i,autoResizeViewport:!1,onInitialize:o=>this._setDevice(o.device),onRender:this._onRenderFrame.bind(this),onError:s})}_getViewState(){return this.props.viewState||this.viewState}_getViews(){const{views:e}=this.props,t=Array.isArray(e)?e:e?[e]:[new Pe({id:"default-view"})];return t.length&&this.props.controller&&(t[0].props.controller=this.props.controller),t}_onContextLost(){const{onError:e}=this.props;this.animationLoop&&e&&e(new Error("WebGL context is lost"))}_pickAndCallback(){var t,i,s,n;if(((t=this.device)==null?void 0:t.type)==="webgpu")return;const{_pickRequest:e}=this;if(e.event){const{result:o,emptyInfo:a}=this._pick("pickObject","pickObject Time",e);this.cursorState.isHovering=o.length>0;let c=a,h=!1;for(const l of o)c=l,h=((i=l.layer)==null?void 0:i.onHover(l,e.event))||h;h||((n=(s=this.props).onHover)==null||n.call(s,c,e.event),this.widgetManager.onHover(c,e.event)),e.event=null}}_updateCursor(){const e=this.props.parent||this.canvas;e&&(e.style.cursor=this.props.getCursor(this.cursorState))}_setDevice(e){var s,n;if(this.device=e,!this.animationLoop)return;this.canvas||(this.canvas=(s=this.device.canvasContext)==null?void 0:s.canvas),this.device.type==="webgl"&&this.device.setParametersWebGL({blend:!0,blendFunc:[770,771,1,771],polygonOffsetFill:!0,depthTest:!0,depthFunc:515}),this.props.onDeviceInitialized(this.device),this.device.type==="webgl"&&this.props.onWebGLInitialized(this.device.gl);const t=new dt;t.play(),this.animationLoop.attachTimeline(t),this.eventManager=new ds(this.props.parent||this.canvas,{touchAction:this.props.touchAction,recognizers:Object.keys(Ae).map(o=>{var p;const[a,c,h,l]=Ae[o],u=(p=this.props.eventRecognizerOptions)==null?void 0:p[o],d={...c,...u,event:o};return{recognizer:new a(d),recognizeWith:h,requestFailure:l}}),events:{pointerdown:this._onPointerDown,pointermove:this._onPointerMove,pointerleave:this._onPointerMove}});for(const o in ce)this.eventManager.on(o,this._onEvent);this.viewManager=new nn({timeline:t,eventManager:this.eventManager,onViewStateChange:this._onViewStateChange.bind(this),onInteractionStateChange:this._onInteractionStateChange.bind(this),views:this._getViews(),viewState:this._getViewState(),width:this.width,height:this.height});const i=this.viewManager.getViewports()[0];this.layerManager=new sn(this.device,{deck:this,stats:this.stats,viewport:i,timeline:t}),this.effectManager=new _n({deck:this,device:this.device}),this.deckRenderer=new En(this.device),this.deckPicker=new Cn(this.device),this.widgetManager=new xn({deck:this,parentElement:(n=this.canvas)==null?void 0:n.parentElement}),this.widgetManager.addDefault(new In),this.setProps(this.props),this._updateCanvasSize(),this.props.onLoad()}_drawLayers(e,t){var o;const{device:i,gl:s}=this.layerManager.context;this.props.onBeforeRender({device:i,gl:s});const n={target:this.props._framebuffer,layers:this.layerManager.getLayers(),viewports:this.viewManager.getViewports(),onViewportActive:this.layerManager.activateViewport,views:this.viewManager.getViews(),pass:"screen",effects:this.effectManager.getEffects(),...t};(o=this.deckRenderer)==null||o.renderLayers(n),n.pass==="screen"&&this.widgetManager.onRedraw({viewports:n.viewports,layers:n.layers}),this.props.onAfterRender({device:i,gl:s})}_onRenderFrame(){var e;this._getFrameStats(),this._metricsCounter++%60===0&&(this._getMetrics(),this.stats.reset(),y.table(4,this.metrics)(),this.props._onMetrics&&this.props._onMetrics(this.metrics)),this._updateCanvasSize(),this._updateCursor(),this.layerManager.updateLayers(),((e=this.device)==null?void 0:e.type)!=="webgpu"&&this._pickAndCallback(),this.redraw(),this.viewManager&&this.viewManager.updateViewStates()}_onViewStateChange(e){const t=this.props.onViewStateChange(e)||e.viewState;this.viewState&&(this.viewState={...this.viewState,[e.viewId]:t},this.props.viewState||this.viewManager&&this.viewManager.setProps({viewState:this.viewState}))}_onInteractionStateChange(e){this.cursorState.isDragging=e.isDragging||!1,this.props.onInteractionStateChange(e)}_getFrameStats(){const{stats:e}=this;e.get("frameRate").timeEnd(),e.get("frameRate").timeStart();const t=this.animationLoop.stats;e.get("GPU Time").addTime(t.get("GPU Time").lastTiming),e.get("CPU Time").addTime(t.get("CPU Time").lastTiming)}_getMetrics(){const{metrics:e,stats:t}=this;e.fps=t.get("frameRate").getHz(),e.setPropsTime=t.get("setProps Time").time,e.updateAttributesTime=t.get("Update Attributes").time,e.framesRedrawn=t.get("Redraw Count").count,e.pickTime=t.get("pickObject Time").time+t.get("pickMultipleObjects Time").time+t.get("pickObjects Time").time,e.pickCount=t.get("Pick Count").count,e.gpuTime=t.get("GPU Time").time,e.cpuTime=t.get("CPU Time").time,e.gpuTimePerFrame=t.get("GPU Time").getAverageTime(),e.cpuTimePerFrame=t.get("CPU Time").getAverageTime();const i=pe.stats.get("Memory Usage");e.bufferMemory=i.get("Buffer Memory").count,e.textureMemory=i.get("Texture Memory").count,e.renderbufferMemory=i.get("Renderbuffer Memory").count,e.gpuMemory=i.get("GPU Memory").count}}H.defaultProps=_t;H.VERSION=zi;class Bn extends gt{applyConstraints(e){const{maxZoom:t,minZoom:i,zoom:s}=e;e.zoom=U(s,i,t);const{longitude:n,latitude:o}=e;return(n<-180||n>180)&&(e.longitude=Xt(n+180,360)-180),e.latitude=U(o,-85.051129,Yt),e}}class Gn extends ft{constructor(){super(...arguments),this.ControllerState=Bn,this.transition={transitionDuration:300,transitionInterpolator:new be(["longitude","latitude","zoom"])},this.dragMode="pan"}setProps(e){super.setProps(e),this.dragRotate=!1,this.touchRotate=!1}}class vt extends pt{constructor(e={}){super(e)}getViewportType(e){return e.zoom>12?nt:Kt}get ControllerType(){return Gn}}vt.displayName="GlobeView";const re=512,Wn=Math.PI/180;function yt({map:r,gl:e,deck:t}){if(r.__deck)return r.__deck;const i=t==null?void 0:t.props._customRender,s=t==null?void 0:t.props.onLoad,n={...t==null?void 0:t.props,_customRender:()=>{r.triggerRepaint(),i==null||i("")}};n.parameters={...me(r,!0),...n.parameters},n.views||(n.views=te(r));let o;return(!t||t.props.gl===e)&&(Object.assign(n,{gl:e,width:null,height:null,touchAction:"unset",viewState:Z(r)}),t!=null&&t.isInitialized?Qe(t,r):n.onLoad=()=>{s==null||s(),Qe(o,r)}),t?(o=t,t.setProps(n),t.userData.isExternal=!0):(o=new H(n),r.on("remove",()=>{Et(r)})),o.userData.mapboxLayers=new Set,r.__deck=o,r.on("render",()=>{o.isInitialized&&Yn(o,r)}),o}function Qe(r,e){const t=()=>{r.isInitialized?Kn(r,e):e.off("move",t)};e.on("move",t)}function Et(r){var e;(e=r.__deck)==null||e.finalize(),r.__deck=null}function me(r,e){const t=e?{depthWriteEnabled:!0,depthCompare:"less-equal",depthBias:0,blend:!0,blendColorSrcFactor:"src-alpha",blendColorDstFactor:"one-minus-src-alpha",blendAlphaSrcFactor:"one",blendAlphaDstFactor:"one-minus-src-alpha",blendColorOperation:"add",blendAlphaOperation:"add"}:{};return bt(r)==="globe"&&(t.cullMode="back"),t}function Hn(r,e){r.userData.mapboxLayers.add(e),Se(r)}function Zn(r,e){r.userData.mapboxLayers.delete(e),Se(r)}function $n(r,e){Se(r)}function qn(r,e,t,i){let{currentViewport:s}=r.userData,n=!1;s||(s=Pt(r,e,i),r.userData.currentViewport=s,n=!0),r.isInitialized&&r._drawLayers("mapbox-repaint",{viewports:[s],layerFilter:({layer:o})=>t.id===o.id||o.props.operation.includes("terrain"),clearStack:n,clearCanvas:!1})}function bt(r){var i;const e=(i=r.getProjection)==null?void 0:i.call(r),t=(e==null?void 0:e.type)||(e==null?void 0:e.name);if(t==="globe")return"globe";if(t&&t!=="mercator")throw new Error("Unsupported projection");return"mercator"}function te(r){return bt(r)==="globe"?new vt({id:"mapbox"}):new Pe({id:"mapbox"})}function Z(r){var s;const{lng:e,lat:t}=r.getCenter(),i={longitude:(e+540)%360-180,latitude:t,zoom:r.getZoom(),bearing:r.getBearing(),pitch:r.getPitch(),padding:r.getPadding(),repeat:r.getRenderWorldCopies()};return(s=r.getTerrain)!=null&&s.call(r)&&Xn(r,i),i}function Xn(r,e){if(r.getFreeCameraOptions){const{position:t}=r.getFreeCameraOptions();if(!t||t.z===void 0)return;const i=r.transform.height,{longitude:s,latitude:n,pitch:o}=e,a=t.x*re,c=(1-t.y)*re,h=t.z*re,l=Jt([s,n]),u=a-l[0],d=c-l[1],p=Math.sqrt(u*u+d*d),g=o*Wn,f=1.5*i,m=g<.001?f*Math.cos(g)/h:f*Math.sin(g)/p;e.zoom=Math.log2(m);const v=f*Math.cos(g)/m,_=h-v;e.position=[0,0,_/Qt(n)]}else typeof r.transform.elevation=="number"&&(e.position=[0,0,r.transform.elevation])}function Pt(r,e,t){const i=Z(e),s=te(e);t&&(s.props.nearZMultiplier=.2);const n=(t==null?void 0:t.nearZ)??e.transform._nearZ,o=(t==null?void 0:t.farZ)??e.transform._farZ;return Number.isFinite(n)&&(i.nearZ=n/e.transform.height,i.farZ=o/e.transform.height),s.makeViewport({width:r.width,height:r.height,viewState:i})}function Yn(r,e){const{mapboxLayers:t,isExternal:i}=r.userData;if(i){const s=Array.from(t,l=>l.id),o=W(r.props.layers,Boolean).some(l=>l&&!s.includes(l.id));let a=r.getViewports();const c=a.findIndex(l=>l.id==="mapbox"),h=a.length>1||c<0;(o||h)&&(c>=0&&(a=a.slice(),a[c]=Pt(r,e)),r._drawLayers("mapbox-repaint",{viewports:a,layerFilter:l=>(!r.props.layerFilter||r.props.layerFilter(l))&&(l.viewport.id!=="mapbox"||!s.includes(l.layer.id)),clearCanvas:!1}))}r.userData.currentViewport=null}function Kn(r,e){r.setProps({viewState:Z(e)}),r.needsRedraw({clearRedrawFlags:!0})}function Se(r){if(r.userData.isExternal)return;const e=[];r.userData.mapboxLayers.forEach(t=>{const i=t.props.type,s=new i(t.props);e.push(s)}),r.setProps({layers:e})}class Jn{constructor(e){if(!e.id)throw new Error("Layer must have an unique id");this.id=e.id,this.type="custom",this.renderingMode=e.renderingMode||"3d",this.slot=e.slot,this.map=null,this.deck=null,this.props=e}onAdd(e,t){this.map=e,this.deck=yt({map:e,gl:t,deck:this.props.deck}),Hn(this.deck,this)}onRemove(){this.deck&&Zn(this.deck,this)}setProps(e){Object.assign(this.props,e,{id:this.id}),this.deck&&$n(this.deck)}render(e,t){qn(this.deck,this.map,this,t)}}const oe="__UNDEFINED__";function Q(r,e,t,i){if(!r||!e||!r.style||!r.style._loaded)return;const s=W(i,Boolean);if(t!==i){const a=W(t,Boolean),c=new Set(a.map(h=>h.id));for(const h of s)c.delete(h.id);for(const h of c)r.getLayer(h)&&r.removeLayer(h)}for(const a of s){const c=r.getLayer(a.id);c?(c.implementation||c).setProps(a.props):r.addLayer(new Jn({id:a.id,deck:e,slot:a.props.slot}),a.props.beforeId)}const n=r.style._order,o={};for(const a of s){let{beforeId:c}=a.props;(!c||!n.includes(c))&&(c=oe),o[c]=o[c]||[],o[c].push(a.id)}for(const a in o){const c=o[a];let h=a===oe?n.length:n.indexOf(a),l=a===oe?void 0:a;for(let u=c.length-1;u>=0;u--){const d=c[u],p=n.indexOf(d);p!==h-1&&(r.moveLayer(d,l),p>h&&h++),h--,l=d}}}class tr{constructor(e){this._handleStyleChange=()=>{Q(this._map,this._deck,this._props.layers,this._props.layers)},this._updateContainerSize=()=>{if(this._map&&this._container){const{clientWidth:s,clientHeight:n}=this._map.getContainer();Object.assign(this._container.style,{width:`${s}px`,height:`${n}px`})}},this._updateViewState=()=>{const s=this._deck,n=this._map;s&&n&&(s.setProps({views:this._props.views||te(n),viewState:Z(n)}),s.isInitialized&&s.redraw())},this._handleMouseEvent=s=>{const n=this._deck;if(!n||!n.isInitialized)return;const o={type:s.type,offsetCenter:s.point,srcEvent:s},a=this._lastMouseDownPoint;switch(!s.point&&a&&(o.deltaX=s.originalEvent.clientX-a.clientX,o.deltaY=s.originalEvent.clientY-a.clientY,o.offsetCenter={x:a.x+o.deltaX,y:a.y+o.deltaY}),o.type){case"mousedown":n._onPointerDown(o),this._lastMouseDownPoint={...s.point,clientX:s.originalEvent.clientX,clientY:s.originalEvent.clientY};break;case"dragstart":o.type="panstart",n._onEvent(o);break;case"drag":o.type="panmove",n._onEvent(o);break;case"dragend":o.type="panend",n._onEvent(o);break;case"click":o.tapCount=1,n._onEvent(o);break;case"dblclick":o.type="click",o.tapCount=2,n._onEvent(o);break;case"mousemove":o.type="pointermove",n._onPointerMove(o);break;case"mouseout":o.type="pointerleave",n._onPointerMove(o);break;default:return}};const{interleaved:t=!1,...i}=e;this._interleaved=t,this._props=i}setProps(e){this._interleaved&&e.layers&&Q(this._map,this._deck,this._props.layers,e.layers),Object.assign(this._props,e),this._deck&&this._map&&this._deck.setProps({...this._props,parameters:{...me(this._map,this._interleaved),...this._props.parameters}})}onAdd(e){return this._map=e,this._interleaved?this._onAddInterleaved(e):this._onAddOverlaid(e)}_onAddOverlaid(e){const t=document.createElement("div");return Object.assign(t.style,{position:"absolute",left:0,top:0,textAlign:"initial",pointerEvents:"none"}),this._container=t,this._deck=new H({...this._props,parent:t,parameters:{...me(e,!1),...this._props.parameters},views:this._props.views||te(e),viewState:Z(e)}),e.on("resize",this._updateContainerSize),e.on("render",this._updateViewState),e.on("mousedown",this._handleMouseEvent),e.on("dragstart",this._handleMouseEvent),e.on("drag",this._handleMouseEvent),e.on("dragend",this._handleMouseEvent),e.on("mousemove",this._handleMouseEvent),e.on("mouseout",this._handleMouseEvent),e.on("click",this._handleMouseEvent),e.on("dblclick",this._handleMouseEvent),this._updateContainerSize(),t}_onAddInterleaved(e){const t=e.painter.context.gl;return t instanceof WebGLRenderingContext&&y.warn("Incompatible basemap library. See: https://deck.gl/docs/api-reference/mapbox/overview#compatibility")(),this._deck=yt({map:e,gl:t,deck:new H({...this._props,gl:t})}),e.on("styledata",this._handleStyleChange),Q(e,this._deck,[],this._props.layers),document.createElement("div")}onRemove(){const e=this._map;e&&(this._interleaved?this._onRemoveInterleaved(e):this._onRemoveOverlaid(e)),this._deck=void 0,this._map=void 0,this._container=void 0}_onRemoveOverlaid(e){var t;e.off("resize",this._updateContainerSize),e.off("render",this._updateViewState),e.off("mousedown",this._handleMouseEvent),e.off("dragstart",this._handleMouseEvent),e.off("drag",this._handleMouseEvent),e.off("dragend",this._handleMouseEvent),e.off("mousemove",this._handleMouseEvent),e.off("mouseout",this._handleMouseEvent),e.off("click",this._handleMouseEvent),e.off("dblclick",this._handleMouseEvent),(t=this._deck)==null||t.finalize()}_onRemoveInterleaved(e){e.off("styledata",this._handleStyleChange),Q(e,this._deck,this._props.layers,[]),Et(e)}getDefaultPosition(){return"top-left"}pickObject(e){return M(this._deck),this._deck.pickObject(e)}pickMultipleObjects(e){return M(this._deck),this._deck.pickMultipleObjects(e)}pickObjects(e){return M(this._deck),this._deck.pickObjects(e)}finalize(){this._map&&this._map.removeControl(this)}getCanvas(){return this._map?this._interleaved?this._map.getCanvas():this._deck.getCanvas():null}}export{tr as MapboxOverlay};
